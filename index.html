<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpotSwap ‚Äî Scambia spot</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
   integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
   crossorigin=""/>
  <style>
    :root{
      --bg:#0d0d0d;
      --bg-light:#1a1a1a;
      --card:#1f1f1f;
      --card-hover:#252525;
      --border:#2a2a2a;
      --border-light:#333;
      --text:#f5f5f5;
      --text-muted:#999;
      --primary:#dc2626;
      --primary-hover:#b91c1c;
      --primary-light:#ef4444;
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#dc2626;
      --info:#6366f1;
      --radius:10px;
      --shadow:0 2px 8px rgba(0,0,0,.3);
      --shadow-lg:0 8px 24px rgba(0,0,0,.4);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
    }

    /* LAYOUT */
    header{
      background:linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(10px);
    }
    
    .header-content{
      max-width:1200px;
      margin:0 auto;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    
    .logo-area{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    
    .logo{
      width:40px;
      height:40px;
      border-radius:50%;
      display:grid;
      place-items:center;
      overflow:hidden;
      box-shadow:0 4px 12px rgba(220,38,38,.3);
    }
    
    .logo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    
    .brand h1{
      font-size:18px;
      color:var(--text);
      white-space:nowrap;
      font-weight:700;
      letter-spacing:-0.5px;
      line-height:1.2;
    }
    
    .brand p{
      font-size:11px;
      color:var(--text-muted);
      white-space:nowrap;
      font-weight:500;
    }
    
    .brand .gang-name{
      font-size:10px;
      color:var(--primary);
      margin-top:2px;
      font-weight:600;
    }

    nav{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1;
      min-width:0;
    }
    
    .nav-btn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 14px;
      border-radius:7px;
      cursor:pointer;
      font-weight:600;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size:13px;
      position:relative;
      white-space:nowrap;
      flex-shrink:0;
    }
    
    .nav-btn:hover{
      background:var(--card);
      border-color:var(--primary);
      transform:translateY(-1px);
    }
    
    .nav-btn.active{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:white;
      box-shadow:0 4px 12px rgba(220,38,38,.25);
    }

    .nav-btn .badge-count{
      position:absolute;
      top:-6px;
      right:-6px;
      background:var(--primary);
      color:white;
      border-radius:10px;
      padding:2px 6px;
      font-size:10px;
      font-weight:700;
      min-width:16px;
      text-align:center;
      box-shadow:0 2px 6px rgba(220,38,38,.4);
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
    }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:16px;
      transition:all .3s ease;
    }

    .spot-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    
    .spot-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:linear-gradient(90deg,var(--primary),var(--primary-light));
      opacity:0;
      transition:opacity .3s ease;
    }
    
    .spot-card:hover{
      border-color:var(--primary);
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
      background:var(--card-hover);
    }
    
    .spot-card:hover::before{
      opacity:1;
    }

    .spot-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }

    .spot-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:4px;
      color:var(--text);
      letter-spacing:-0.3px;
    }

    .spot-meta{
      font-size:12px;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500;
    }

    .spot-exchange{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:10px;
      margin:10px 0;
      font-size:13px;
    }

    .spot-exchange-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    
    .spot-exchange-row:last-child{
      margin-bottom:0;
    }

    .spot-exchange strong{
      color:var(--primary);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }

    /* BADGES */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:5px;
      font-size:11px;
      font-weight:700;
      border:1px solid;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .badge-primary{
      background:rgba(220,38,38,.15);
      border-color:var(--primary);
      color:var(--primary-light);
    }

    .badge-success{
      background:rgba(34,197,94,.15);
      border-color:var(--success);
      color:var(--success);
    }

    .badge-warning{
      background:rgba(245,158,11,.15);
      border-color:var(--warning);
      color:var(--warning);
    }

    .badge-danger{
      background:rgba(220,38,38,.15);
      border-color:var(--danger);
      color:var(--danger);
    }

    .badge-info{
      background:rgba(99,102,241,.15);
      border-color:var(--info);
      color:var(--info);
    }

    /* BUTTONS */
    .btn{
      padding:10px 18px;
      border-radius:7px;
      border:1px solid;
      font-weight:600;
      cursor:pointer;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size:13px;
      text-align:center;
      display:inline-block;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:white;
      box-shadow:0 4px 12px rgba(220,38,38,.2);
    }

    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(220,38,38,.3);
    }

    .btn-success{
      background:var(--success);
      border-color:var(--success);
      color:white;
    }
    
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(34,197,94,.3);
    }

    .btn-danger{
      background:var(--danger);
      border-color:var(--danger);
      color:white;
    }

    .btn-ghost{
      background:transparent;
      border-color:var(--border);
      color:var(--text);
    }

    .btn-ghost:hover{
      background:var(--card);
      border-color:var(--border-light);
    }

    .btn-lg{
      padding:12px 24px;
      font-size:14px;
      width:100%;
    }

    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    /* FORMS */
    .form-group{
      margin-bottom:16px;
    }

    .form-label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
      font-size:13px;
      color:var(--text);
      letter-spacing:0.3px;
    }

    .form-input,
    .form-select,
    .form-textarea{
      width:100%;
      background:var(--bg-light);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:7px;
      font-size:13px;
      transition:all .2s;
      font-family:inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(220,38,38,.1);
    }

    .form-textarea{
      min-height:100px;
      resize:vertical;
    }

    .form-hint{
      font-size:11px;
      color:var(--text-muted);
      margin-top:4px;
      font-weight:500;
    }

    .form-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }

    .checkbox-label{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      cursor:pointer;
      transition:all .2s;
    }
    
    .checkbox-label:hover{
      border-color:var(--border-light);
      background:var(--card);
    }

    .checkbox-label input{
      margin-top:2px;
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:14px;
    }

    @media (max-width:768px){
      .grid{
        grid-template-columns:1fr;
        gap:12px;
      }
    }

    /* FILTERS */
    .filters{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:16px;
    }

    /* ALERT */
    .alert{
      padding:12px 16px;
      border-radius:7px;
      margin-bottom:16px;
      border:1px solid;
      font-size:13px;
      font-weight:500;
    }

    .alert-info{
      background:rgba(99,102,241,.1);
      border-color:var(--info);
      color:var(--text);
    }

    .alert-warning{
      background:rgba(245,158,11,.1);
      border-color:var(--warning);
      color:var(--text);
    }

    .alert-success{
      background:rgba(34,197,94,.1);
      border-color:var(--success);
      color:var(--text);
    }

    /* MODAL */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
      z-index:999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      animation:fadeIn .2s ease;
    }

    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }

    .modal-overlay.show{
      display:flex;
    }

    .modal{
      background:var(--card);
      border:1px solid var(--border-light);
      border-radius:var(--radius);
      padding:20px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      animation:slideUp .3s ease;
    }

    @keyframes slideUp{
      from{
        opacity:0;
        transform:translateY(20px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }

    .modal-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.5px;
    }

    .modal-close{
      background:transparent;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:var(--text-muted);
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      transition:all .2s;
    }
    
    .modal-close:hover{
      background:var(--bg-light);
      color:var(--text);
    }

    /* TRADE REQUEST */
    .trade-request{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:14px;
      margin-bottom:12px;
      transition:all .2s;
    }
    
    .trade-request:hover{
      border-color:var(--border-light);
    }

    .trade-status{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:5px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .trade-status.pending{
      background:rgba(245,158,11,.15);
      color:var(--warning);
    }

    .trade-status.verifying{
      background:rgba(99,102,241,.15);
      color:var(--info);
    }

    .trade-status.accepted{
      background:rgba(34,197,94,.15);
      color:var(--success);
    }

    .trade-status.rejected{
      background:rgba(220,38,38,.15);
      color:var(--danger);
    }

    .spot-selector{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition:all .2s;
      display:flex;
      align-items:flex-start;
      gap:12px;
    }

    .spot-selector:hover{
      border-color:var(--border-light);
      background:var(--card);
    }

    .spot-selector.selected{
      border-color:var(--primary);
      background:rgba(220,38,38,.05);
    }

    .spot-selector input[type="checkbox"],
    .spot-selector input[type="radio"]{
      margin-top:4px;
      flex-shrink:0;
    }
    
    .spot-selector-content{
      flex:1;
    }

    /* COORDINATES REVEAL */
    .coordinates-box{
      background:linear-gradient(135deg,var(--success),#16a34a);
      color:white;
      padding:14px;
      border-radius:8px;
      margin:12px 0;
      font-family:monospace;
      font-size:13px;
      box-shadow:0 4px 12px rgba(34,197,94,.2);
    }

    .coordinates-box strong{
      display:block;
      margin-bottom:6px;
      font-size:14px;
      font-weight:700;
    }

    /* TOAST */
    .toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:var(--card);
      border:1px solid var(--border-light);
      color:var(--text);
      padding:14px 18px;
      border-radius:8px;
      box-shadow:var(--shadow-lg);
      z-index:1000;
      display:none;
      min-width:250px;
      font-size:13px;
      font-weight:600;
      animation:slideInRight .3s ease;
    }

    @keyframes slideInRight{
      from{
        opacity:0;
        transform:translateX(100px);
      }
      to{
        opacity:1;
        transform:translateX(0);
      }
    }

    .toast.show{display:block}

    .toast.success{
      border-color:var(--success);
      background:rgba(34,197,94,.15);
      color:var(--success);
    }

    .toast.error{
      border-color:var(--danger);
      background:rgba(220,38,38,.15);
      color:var(--danger);
    }

    /* UTILITY */
    .hidden{display:none!important}
    .text-center{text-align:center}
    .text-muted{color:var(--text-muted)}
    .mt-2{margin-top:12px}
    .mb-2{margin-bottom:12px}
    .flex{display:flex}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .gap-2{gap:12px}

    h2{
      font-size:22px;
      margin-bottom:6px;
      font-weight:700;
      letter-spacing:-0.5px;
    }

    h3{
      font-size:16px;
      margin-bottom:10px;
      font-weight:700;
      letter-spacing:-0.3px;
    }

    .section-header{
      margin-bottom:16px;
    }

    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--text-muted);
    }

    .empty-state-icon{
      font-size:40px;
      margin-bottom:12px;
      opacity:.6;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:16px;
      border-bottom:1px solid var(--border);
      overflow-x:auto;
      padding-bottom:2px;
    }

    .tab{
      padding:10px 16px;
      background:transparent;
      border:none;
      color:var(--text-muted);
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all .2s;
      font-weight:600;
      white-space:nowrap;
      flex-shrink:0;
      font-size:13px;
    }

    .tab:hover{
      color:var(--text);
    }

    .tab.active{
      color:var(--primary);
      border-bottom-color:var(--primary);
    }

    /* MAP VIEW - FIXED FOR MOBILE */
    .map-container{
      background:var(--bg-light);
      border-radius:var(--radius);
      overflow:hidden;
      position:relative;
      width:100%;
      height:500px; /* Desktop height */
      margin-bottom:0;
      display:flex;
      flex-direction:column;
    }
    
    #map {
      flex:1;
      width:100%;
      border-radius:var(--radius);
      z-index:1;
      min-height:300px;
    }
    
    .leaflet-container {
      background: var(--bg-light) !important;
      font-family: inherit !important;
      width:100% !important;
      height:100% !important;
    }
    
    .leaflet-popup-content {
      color: var(--text) !important;
      background: var(--card) !important;
      font-size:12px !important;
    }
    
    .leaflet-popup-content-wrapper {
      background: var(--card) !important;
      border: 1px solid var(--border) !important;
      color: var(--text) !important;
      border-radius: 8px !important;
      padding:8px !important;
      max-width:250px !important;
    }
    
    .leaflet-popup-tip {
      background: var(--card) !important;
      border: 1px solid var(--border) !important;
    }
    
    .leaflet-control-attribution {
      background: rgba(0,0,0,0.7) !important;
      color: var(--text-muted) !important;
      font-size:10px !important;
      padding:2px 5px !important;
    }
    
    .leaflet-control-attribution a {
      color: var(--primary-light) !important;
      font-size:10px !important;
    }
    
    .leaflet-control-zoom a {
      background: var(--card) !important;
      color: var(--text) !important;
      border-color: var(--border) !important;
      width:30px !important;
      height:30px !important;
      line-height:30px !important;
    }
    
    .leaflet-control-zoom a:hover {
      background: var(--card-hover) !important;
    }
    
    .leaflet-control-zoom {
      border:none !important;
      box-shadow:var(--shadow) !important;
      border-radius:5px !important;
      overflow:hidden;
    }
    
    /* Map controls container */
    .map-controls-container {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:center;
      padding:12px 0;
      margin-top:0;
      background:var(--card);
      border-top:1px solid var(--border);
      position:relative;
      z-index:10;
    }
    
    .map-controls-container .btn {
      padding:8px 12px;
      font-size:12px;
      flex:1;
      min-width:120px;
      max-width:150px;
    }

    /* PROFILE STATS */
    .profile-stats{
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
      gap:12px;
      margin-bottom:20px;
    }
    
    .stat-card{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:16px;
      text-align:center;
    }
    
    .stat-value{
      font-size:24px;
      font-weight:700;
      color:var(--primary);
      margin-bottom:4px;
    }
    
    .stat-label{
      font-size:12px;
      color:var(--text-muted);
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    /* PROFILE SETTINGS */
    .settings-grid{
      display:grid;
      grid-template-columns:1fr;
      gap:16px;
    }
    
    .setting-item{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:16px;
    }
    
    .setting-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
    }
    
    .setting-title{
      font-size:14px;
      font-weight:600;
      color:var(--text);
    }
    
    .setting-description{
      font-size:12px;
      color:var(--text-muted);
      line-height:1.4;
    }
    
    .setting-control{
      margin-top:12px;
    }
    
    .setting-switch{
      display:flex;
      align-items:center;
      gap:10px;
    }
    
    .switch{
      position:relative;
      display:inline-block;
      width:50px;
      height:26px;
    }
    
    .switch input{
      opacity:0;
      width:0;
      height:0;
    }
    
    .slider{
      position:absolute;
      cursor:pointer;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background-color:var(--border);
      transition:.4s;
      border-radius:34px;
    }
    
    .slider:before{
      position:absolute;
      content:"";
      height:18px;
      width:18px;
      left:4px;
      bottom:4px;
      background-color:white;
      transition:.4s;
      border-radius:50%;
    }
    
    input:checked + .slider{
      background-color:var(--primary);
    }
    
    input:checked + .slider:before{
      transform:translateX(24px);
    }

    /* ACTION BUTTONS FOR SPOTS */
    .spot-actions{
      display:flex;
      gap:8px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    
    .spot-actions .btn{
      flex:1;
      min-width:120px;
      padding:8px 12px;
      font-size:12px;
    }

    /* RESPONSIVE */
    @media (max-width:768px){
      .header-content{
        flex-direction:row;
        flex-wrap:wrap;
        padding:10px 16px;
        gap:10px;
      }
      
      .logo-area{
        flex:1;
        min-width:0;
      }
      
      .logo{
        width:36px;
        height:36px;
      }
      
      .brand h1{
        font-size:16px;
      }
      
      .brand p{
        font-size:10px;
      }
      
      .brand .gang-name{
        font-size:9px;
      }
      
      nav{
        order:2;
        flex:1 1 100%;
        overflow-x:auto;
        padding-bottom:6px;
        justify-content:flex-start;
        margin-top:0;
        -webkit-overflow-scrolling:touch;
        scrollbar-width:none;
      }
      
      nav::-webkit-scrollbar{
        display:none;
      }
      
      .nav-btn{
        padding:7px 12px;
        font-size:12px;
        flex-shrink:0;
      }
      
      .nav-btn .badge-count{
        position:relative;
        top:0;
        right:0;
        margin-left:4px;
        display:inline-block;
      }

      .container{
        padding:14px;
      }
      
      .form-row{
        grid-template-columns:1fr;
      }

      .toast{
        left:14px;
        right:14px;
        bottom:14px;
        min-width:auto;
      }
      
      .grid{
        grid-template-columns:1fr;
        gap:10px;
      }
      
      .card{
        padding:16px;
        margin-bottom:12px;
      }
      
      .spot-card{
        padding:14px;
      }
      
      .modal{
        padding:18px 14px;
        margin:10px;
        max-height:85vh;
      }
      
      .section-header h2{
        font-size:20px;
      }
      
      .filters{
        padding:14px;
      }
      
      .spot-title{
        font-size:14px;
      }
      
      .spot-meta{
        font-size:11px;
      }
      
      /* MAP FIXES FOR MOBILE */
      .map-container {
        height:70vh !important;
        min-height:400px;
        max-height:600px;
        margin-bottom:0;
        border-radius:8px;
        overflow:hidden;
      }
      
      #map {
        height:100% !important;
        min-height:350px;
      }
      
      .leaflet-container {
        height:100% !important;
        min-height:350px;
      }
      
      .leaflet-control-zoom a {
        width:36px !important;
        height:36px !important;
        line-height:36px !important;
        font-size:18px !important;
      }
      
      .map-controls-container {
        padding:10px 0;
        gap:6px;
      }
      
      .map-controls-container .btn {
        padding:8px 10px;
        font-size:11px;
        min-width:100px;
        max-width:130px;
        flex:1 1 auto;
      }
      
      .profile-stats{
        grid-template-columns:repeat(2, 1fr);
        gap:10px;
      }
      
      .spot-actions .btn{
        min-width:calc(50% - 4px);
      }
      
      .settings-grid{
        grid-template-columns:1fr;
        gap:12px;
      }
      
      .stat-card{
        padding:12px;
      }
      
      .stat-value{
        font-size:20px;
      }
      
      .tabs{
        overflow-x:auto;
        scrollbar-width:none;
        padding-bottom:0;
      }
      
      .tabs::-webkit-scrollbar{
        display:none;
      }
      
      .tab{
        padding:8px 12px;
        font-size:12px;
        white-space:nowrap;
      }
    }
    
    @media (max-width:480px){
      .logo{
        width:32px;
        height:32px;
      }
      
      .brand h1{
        font-size:15px;
      }
      
      .nav-btn{
        padding:6px 10px;
        font-size:11px;
      }
      
      .tabs{
        gap:4px;
      }
      
      .tab{
        padding:8px 12px;
        font-size:12px;
      }
      
      .spot-exchange{
        padding:8px;
        font-size:12px;
      }
      
      .profile-stats{
        grid-template-columns:1fr;
        gap:8px;
      }
      
      .spot-actions .btn{
        min-width:100%;
      }
      
      /* MAP FIXES FOR SMALL MOBILE */
      .map-container {
        height:65vh !important;
        min-height:350px;
        max-height:500px;
      }
      
      #map {
        min-height:300px;
      }
      
      .leaflet-container {
        min-height:300px;
      }
      
      .map-controls-container {
        flex-direction:column;
        align-items:stretch;
        gap:6px;
      }
      
      .map-controls-container .btn {
        min-width:100%;
        max-width:100%;
        padding:10px;
      }
      
      .leaflet-popup-content-wrapper {
        max-width:200px !important;
        padding:6px !important;
      }
      
      .leaflet-popup-content {
        font-size:11px !important;
        line-height:1.3 !important;
      }
    }
    
    @media (max-width:320px){
      .map-container {
        height:60vh !important;
        min-height:300px;
      }
      
      #map {
        min-height:250px;
      }
      
      .leaflet-container {
        min-height:250px;
      }
    }

    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar{
      width:8px;
      height:8px;
    }

    ::-webkit-scrollbar-track{
      background:var(--bg-light);
    }

    ::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:4px;
    }

    ::-webkit-scrollbar-thumb:hover{
      background:var(--border-light);
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-content">
      <div class="logo-area">
        <div class="logo">
          <img src="https://yt3.ggpht.com/N4WaWTevD_K5buOS7rOYGHmwowNgBRTA0r6fF5vnylvLEUefL8G4ofnlh9LZ8th2TOrnt0gd-A=s176-c-k-c0x00ffffff-no-rj-mo" alt="2Lost2Find">
        </div>
        <div class="brand">
          <h1>SpotSwap</h1>
          <p>Scambia spot</p>
          <div class="gang-name">2Lost2Find Gang</div>
        </div>
      </div>

      <nav>
        <button class="nav-btn active" data-route="market">
          Mercato
        </button>
        <button class="nav-btn" data-route="requests">
          Richieste
          <span class="badge-count" id="requests-count">3</span>
        </button>
        <button class="nav-btn" data-route="my-spots">
          I miei spot
        </button>
        <button class="nav-btn" data-route="new">
          + Nuovo
        </button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <!-- MARKET VIEW -->
    <section id="view-market">
      <div class="alert alert-info">
        <strong>üîí Sistema sicuro</strong> ‚Äî Coordinate visibili solo dopo scambio completato e verifica
      </div>

      <div class="section-header">
        <h2>Mercato degli scambi</h2>
        <p class="text-muted">Trova spot e proponi uno scambio offrendo i tuoi</p>
      </div>

      <div class="filters">
        <div class="form-row">
          <div class="form-group" style="margin:0">
            <label class="form-label">Cerca</label>
            <input type="text" class="form-input" id="filter-search" placeholder="es. hotel, fabbrica...">
          </div>
          
          <div class="form-group" style="margin:0">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="filter-category">
              <option value="all">Tutte</option>
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 mt-2" style="align-items:center">
          <button class="btn btn-ghost" id="btn-reset-filters">Reset</button>
          <span class="badge badge-primary" id="results-count">15 risultati</span>
        </div>
      </div>

      <div class="grid" id="market-grid"></div>
    </section>

    <!-- REQUESTS VIEW -->
    <section id="view-requests" class="hidden">
      <div class="section-header">
        <h2>Richieste di scambio</h2>
        <p class="text-muted">Gestisci le richieste ricevute e inviate</p>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="received">Ricevute <span id="received-count">(2)</span></button>
        <button class="tab" data-tab="sent">Inviate <span id="sent-count">(1)</span></button>
        <button class="tab" data-tab="all">Tutte</button>
      </div>

      <div id="tab-received">
        <div id="received-requests"></div>
      </div>

      <div id="tab-sent" class="hidden">
        <div id="sent-requests"></div>
      </div>

      <div id="tab-all" class="hidden">
        <div id="all-requests"></div>
      </div>
    </section>

    <!-- MY SPOTS VIEW -->
    <section id="view-my-spots" class="hidden">
      <div class="section-header flex-between">
        <div>
          <h2>I miei spot</h2>
          <p class="text-muted">Gestisci i tuoi spot pubblicati e ottenuti</p>
        </div>
        <button class="btn btn-primary" onclick="showView('new')">+ Nuovo spot</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="published">Pubblicati <span id="published-count">(4)</span></button>
        <button class="tab" data-tab="acquired">Ottenuti <span id="acquired-count">(2)</span></button>
        <button class="tab" data-tab="profile">Profilo</button>
        <button class="tab" data-tab="map">Mappa</button>
      </div>

      <div id="tab-published">
        <div class="grid" id="published-spots-grid"></div>
      </div>

      <div id="tab-acquired" class="hidden">
        <div class="grid" id="acquired-spots-grid"></div>
      </div>

      <div id="tab-profile" class="hidden">
        <div class="profile-stats">
          <div class="stat-card">
            <div class="stat-value" id="total-spots">6</div>
            <div class="stat-label">Spot totali</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="acquired-spots">2</div>
            <div class="stat-label">Spot ottenuti</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completed-trades">3</div>
            <div class="stat-label">Scambi completati</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="success-rate">75%</div>
            <div class="stat-label">Successo scambi</div>
          </div>
        </div>

        <div class="settings-grid">
          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Notifiche</div>
              <div class="setting-switch">
                <label class="switch">
                  <input type="checkbox" id="notifications-toggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-description">
              Ricevi notifiche per nuove richieste e aggiornamenti scambi
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Profilo privato</div>
              <div class="setting-switch">
                <label class="switch">
                  <input type="checkbox" id="private-profile-toggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-description">
              Nascondi le tue statistiche agli altri utenti
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Coordinate precise</div>
              <div class="setting-switch">
                <label class="switch">
                  <input type="checkbox" id="precise-coordinates-toggle">
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-description">
              Mostra coordinate GPS precise dopo lo scambio
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Email di conferma</div>
              <div class="setting-switch">
                <label class="switch">
                  <input type="checkbox" id="email-confirm-toggle" checked>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            <div class="setting-description">
              Ricevi email di conferma per ogni scambio
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Nome utente</div>
            </div>
            <div class="setting-description">
              Il tuo nome pubblico sulla piattaforma
            </div>
            <div class="setting-control">
              <input type="text" class="form-input" id="profile-username" value="UrbexMaster">
            </div>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <div class="setting-title">Bio</div>
            </div>
            <div class="setting-description">
              Breve descrizione del tuo profilo
            </div>
            <div class="setting-control">
              <textarea class="form-textarea" id="profile-bio" rows="3" maxlength="200">Esploratore urbano dal 2015, specializzato in strutture industriali e hotel abbandonati.</textarea>
            </div>
          </div>
        </div>

        <div class="flex gap-2 mt-2">
          <button class="btn btn-primary" onclick="saveProfileSettings()" style="flex:1">Salva modifiche</button>
        </div>
      </div>

      <div id="tab-map" class="hidden">
        <div class="map-container">
          <div id="map"></div>
        </div>
        <div class="map-controls-container">
          <button class="btn btn-ghost" onclick="refreshMap()">üîÑ Aggiorna</button>
          <button class="btn btn-primary" onclick="zoomToItaly()">üó∫Ô∏è Zoom Italia</button>
          <button class="btn btn-ghost" onclick="toggleMarkers('published')">üìù Pubblicati</button>
          <button class="btn btn-ghost" onclick="toggleMarkers('acquired')">üèÜ Ottenuti</button>
          <button class="btn btn-primary" onclick="toggleMarkers('all')">üåç Tutti</button>
        </div>
      </div>
    </section>

    <!-- NEW SPOT VIEW -->
    <section id="view-new" class="hidden">
      <div class="section-header">
        <h2>Pubblica nuovo spot</h2>
        <p class="text-muted">Crea un annuncio per scambiare il tuo spot</p>
      </div>

      <div class="card">
        <div class="form-group">
          <label class="form-label">Cosa offri</label>
          <input type="text" class="form-input" id="input-give" maxlength="100" placeholder="es. Ex fabbrica tessile">
          <div class="form-hint">Descrizione breve dello spot che offri in scambio</div>
        </div>

        <div class="form-group">
          <label class="form-label">Cosa cerchi</label>
          <input type="text" class="form-input" id="input-want" maxlength="100" placeholder="es. Hotel o villa abbandonata">
          <div class="form-hint">Cosa vorresti ricevere in cambio</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Zona generica</label>
            <input type="text" class="form-input" id="input-region" placeholder="es. Lombardia nord">
            <div class="form-hint">Solo zona generica, mai l'indirizzo</div>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="input-category">
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Coordinate GPS</label>
          <input type="text" class="form-input" id="input-coordinates" placeholder="es. 45.4642, 9.1900">
          <div class="form-hint">‚ö†Ô∏è Saranno visibili SOLO dopo l'accettazione dello scambio e verifica</div>
        </div>

        <div class="form-group">
          <label class="form-label">Descrizione</label>
          <textarea class="form-textarea" id="input-description" maxlength="500" placeholder="Descrivi cosa rende speciale questo spot..."></textarea>
          <div class="form-hint">Info generali sullo spot</div>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="input-legal">
          <span>
            <strong>Confermo</strong> di avere accordi personali per questo spot e di poterlo scambiare.
          </span>
        </label>

        <div class="flex gap-2 mt-2">
          <button class="btn btn-ghost" onclick="showView('my-spots')">Annulla</button>
          <button class="btn btn-primary btn-lg" id="btn-publish">Pubblica spot</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: SELECT SPOTS TO OFFER -->
  <div class="modal-overlay" id="modal-offer">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da offrire (max 3)</h3>
        <button class="modal-close" onclick="closeModal('modal-offer')">&times;</button>
      </div>

      <div class="alert alert-info">
        Seleziona fino a 3 tuoi spot da offrire in cambio. Il proprietario sceglier√† quale accettare.
      </div>

      <div id="offer-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-offer')">Annulla</button>
        <button class="btn btn-primary btn-lg" id="btn-send-offer">Invia proposta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHOOSE SPOT FROM OFFER -->
  <div class="modal-overlay" id="modal-choose">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da ricevere</h3>
        <button class="modal-close" onclick="closeModal('modal-choose')">&times;</button>
      </div>

      <div class="alert alert-info">
        Scegli quale spot accettare in cambio del tuo. Puoi selezionarne solo uno.
      </div>

      <div id="choose-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-choose')">Annulla</button>
        <button class="btn btn-success btn-lg" id="btn-accept-trade">Accetta scambio</button>
      </div>
    </div>
  </div>

  <!-- MODAL: SPOT DETAIL -->
  <div class="modal-overlay" id="modal-detail">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="detail-title"></h3>
        <button class="modal-close" onclick="closeModal('modal-detail')">&times;</button>
      </div>

      <div id="detail-content"></div>

      <div id="detail-actions" class="mt-2"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
   integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
   crossorigin=""></script>

  <script>
    // ========== CONSTANTS ==========
    const STORAGE_KEY = 'spotswap_v10';
    const VERIFICATION_TIME = 10000; // 10 seconds

    // ========== STATE ==========
    let state = {
      user: {
        username: 'UrbexMaster',
        id: 'user_' + Date.now(),
        bio: 'Esploratore urbano dal 2015, specializzato in strutture industriali e hotel abbandonati.',
        settings: {
          notifications: true,
          privateProfile: true,
          preciseCoordinates: false,
          emailConfirm: true
        }
      },
      spots: [],
      tradeRequests: [],
      currentOfferId: null,
      currentRequestId: null,
      selectedOfferSpots: []
    };

    // ========== MAP VARIABLES ==========
    let map = null;
    let markers = [];
    let currentMapFilter = 'all';
    let mapInitialized = false;

    // ========== INIT ==========
    function init() {
      loadState();
      setupEventListeners();
      addDemoData();
      showView('market');
      updateUI();
      startVerificationChecker();
      
      // Inizializza la mappa se il tab √® attivo (per mobile)
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          if (document.getElementById('view-my-spots') && !document.getElementById('view-my-spots').classList.contains('hidden')) {
            initMap();
          }
        }, 500);
      }
    }

    // ========== STORAGE ==========
    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error('Error loading state:', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Error saving state:', e);
      }
    }

    // ========== NAVIGATION ==========
    function showView(view) {
      document.querySelectorAll('section[id^="view-"]').forEach(v => {
        v.classList.add('hidden');
      });
      
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.route === view);
      });
      
      if (view === 'market') renderMarket();
      if (view === 'requests') renderRequests();
      if (view === 'my-spots') renderMySpots();
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Inizializza la mappa se si passa al tab mappa
      if (view === 'my-spots') {
        setTimeout(() => {
          const mapTab = document.querySelector('[data-tab="map"]');
          if (mapTab && mapTab.classList.contains('active')) {
            initMap();
          }
        }, 100);
      }
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => showView(btn.dataset.route));
      });

      ['filter-search', 'filter-category'].forEach(id => {
        document.getElementById(id).addEventListener('input', renderMarket);
      });
      
      document.getElementById('btn-reset-filters').addEventListener('click', resetFilters);
      document.getElementById('btn-publish').addEventListener('click', publishSpot);
      document.getElementById('btn-send-offer').addEventListener('click', sendOffer);
      document.getElementById('btn-accept-trade').addEventListener('click', acceptTrade);

      // Tabs per richieste
      document.querySelectorAll('#view-requests .tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          document.querySelectorAll('#view-requests .tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.getElementById('tab-received').classList.toggle('hidden', tabName !== 'received');
          document.getElementById('tab-sent').classList.toggle('hidden', tabName !== 'sent');
          document.getElementById('tab-all').classList.toggle('hidden', tabName !== 'all');
        });
      });

      // Tabs per i miei spot
      document.querySelectorAll('#view-my-spots .tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          document.querySelectorAll('#view-my-spots .tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.getElementById('tab-published').classList.toggle('hidden', tabName !== 'published');
          document.getElementById('tab-acquired').classList.toggle('hidden', tabName !== 'acquired');
          document.getElementById('tab-profile').classList.toggle('hidden', tabName !== 'profile');
          document.getElementById('tab-map').classList.toggle('hidden', tabName !== 'map');
          
          if (tabName === 'map') {
            // D√† un po' di tempo per il rendering del DOM
            setTimeout(() => {
              initMap();
            }, 100);
          } else if (tabName === 'profile') {
            loadProfileSettings();
          }
        });
      });
      
      // Resize handler per la mappa
      window.addEventListener('resize', function() {
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
          }, 200);
        }
      });
    }

    // ========== MAP FUNCTIONS ==========
    function initMap() {
      // Se la mappa esiste gi√†, rimuovila e ricreala
      if (map) {
        map.remove();
        markers.forEach(marker => marker.remove());
        markers = [];
      }

      // Crea la mappa
      map = L.map('map').setView([41.8719, 12.5674], 6); // Centro Italia

      // Aggiungi tile layer scuro
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19,
        detectRetina: true
      }).addTo(map);

      // Aggiungi i marker
      addMarkersToMap();
      
      // Force resize per mobile
      setTimeout(() => {
        if (map) {
          map.invalidateSize();
          mapInitialized = true;
        }
      }, 300);
    }

    function addMarkersToMap() {
      // Recupera tutti gli spot dell'utente
      let userSpots = state.spots.filter(s => 
        (s.author === state.user.username && !s.acquired && !s.offeredForTrade) || 
        (s.acquired && s.currentOwner === state.user.username)
      );

      // Applica filtro se necessario
      if (currentMapFilter === 'published') {
        userSpots = userSpots.filter(s => !s.acquired);
      } else if (currentMapFilter === 'acquired') {
        userSpots = userSpots.filter(s => s.acquired);
      }

      // Se non ci sono spot, mostra messaggio
      if (userSpots.length === 0) {
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]); // Bounds Italia
        map.fitBounds(bounds);
        return;
      }

      // Aggiungi i marker
      userSpots.forEach(spot => {
        let lat, lng;
        
        // Se lo spot ha coordinate, le usiamo
        if (spot.coordinates && spot.coordinates.includes(',')) {
          const coords = spot.coordinates.split(',').map(c => parseFloat(c.trim()));
          if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
            lat = coords[0];
            lng = coords[1];
          }
        }
        
        // Se non ci sono coordinate valide, usiamo coordinate basate sulla regione
        if (!lat || !lng) {
          // Mappa regionale semplificata
          const regionMap = {
            'lombardia': { lat: 45.4642, lng: 9.1900 },
            'bergamo': { lat: 45.6983, lng: 9.6773 },
            'piemonte': { lat: 45.0703, lng: 7.6869 },
            'torino': { lat: 45.0703, lng: 7.6869 },
            'trentino': { lat: 46.4983, lng: 11.3548 },
            'alto adige': { lat: 46.4983, lng: 11.3548 },
            'valle d\'aosta': { lat: 45.7376, lng: 7.3207 },
            'toscana': { lat: 43.7696, lng: 11.2558 },
            'firenze': { lat: 43.7696, lng: 11.2558 },
            'liguria': { lat: 44.4056, lng: 8.9463 },
            'genova': { lat: 44.4056, lng: 8.9463 },
            'emilia': { lat: 44.4949, lng: 11.3426 },
            'romagna': { lat: 44.4949, lng: 11.3426 },
            'umbria': { lat: 43.1107, lng: 12.3908 },
            'perugia': { lat: 43.1107, lng: 12.3908 },
            'veneto': { lat: 45.4408, lng: 12.3155 },
            'venezia': { lat: 45.4408, lng: 12.3155 },
            'lago di como': { lat: 45.8170, lng: 9.0856 },
            'como': { lat: 45.8170, lng: 9.0856 },
            'sardegna': { lat: 39.1642, lng: 8.5219 },
            'carbonia': { lat: 39.1642, lng: 8.5219 }
          };
          
          const regionKey = spot.region.toLowerCase().split('-')[0].trim();
          const regionCoords = regionMap[regionKey];
          
          if (regionCoords) {
            lat = regionCoords.lat;
            lng = regionCoords.lng;
          } else {
            // Coordinate casuali all'interno dell'Italia
            lat = 41.8719 + (Math.random() - 0.5) * 5;
            lng = 12.5674 + (Math.random() - 0.5) * 5;
          }
        }
        
        // Crea il marker con icona personalizzata
        const markerColor = spot.acquired ? '#22c55e' : '#dc2626';
        const markerHtml = `
          <div style="
            background-color: ${markerColor}; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            border: 3px solid white; 
            box-shadow: 0 2px 6px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
          ">
            ${spot.acquired ? '‚úì' : '‚óè'}
          </div>
        `;
        
        const markerIcon = L.divIcon({
          className: 'custom-marker',
          html: markerHtml,
          iconSize: [30, 30],
          iconAnchor: [15, 15],
          popupAnchor: [0, -15]
        });
        
        const marker = L.marker([lat, lng], { icon: markerIcon })
          .addTo(map)
          .bindPopup(`
            <div style="color: var(--text); max-width: 250px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
              <strong style="font-size: 14px; display: block; margin-bottom: 5px;">${escapeHtml(spot.give)}</strong>
              <div style="font-size: 12px; color: #999; margin-bottom: 8px;">
                üìç ${escapeHtml(spot.region)}
              </div>
              <div style="font-size: 11px; margin-bottom: 10px; padding: 5px; background: #1a1a1a; border-radius: 4px;">
                ${spot.acquired ? '‚úÖ Ottenuto' : 'üìù Pubblicato'}
                ${spot.offeredForTrade ? ' ‚Ä¢ üîÑ In offerta' : ''}
              </div>
              <button onclick="viewSpotDetail('${spot.id}'); if(window.map && window.map._popup) window.map._popup.close();" 
                style="background: #dc2626; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; font-size: 12px; width: 100%;">
                Vedi dettagli
              </button>
            </div>
          `);
        
        markers.push(marker);
      });

      // Aggiusta la vista per includere tutti i marker
      if (markers.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
        
        // Per mobile, zoom un po' pi√π indietro
        if (window.innerWidth <= 768 && markers.length > 1) {
          setTimeout(() => {
            map.setZoom(map.getZoom() - 1);
          }, 100);
        }
      } else {
        // Se non ci sono marker, mostra tutta l'Italia
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]);
        map.fitBounds(bounds);
      }
      
      // Force invalidate size per mobile
      if (window.innerWidth <= 768) {
        setTimeout(() => {
          if (map) {
            map.invalidateSize();
          }
        }, 500);
      }
    }

    function refreshMap() {
      if (map) {
        addMarkersToMap();
        showToast('Mappa aggiornata', 'success');
      }
    }

    function zoomToItaly() {
      if (map) {
        const bounds = L.latLngBounds([[47.09, 6.63], [36.65, 18.48]]);
        map.fitBounds(bounds);
        showToast('Zoom sulla posizione Italia', 'info');
      }
    }

    function toggleMarkers(filter) {
      currentMapFilter = filter;
      addMarkersToMap();
      showToast(`Mostrando: ${filter === 'all' ? 'Tutti gli spot' : filter === 'published' ? 'Spot pubblicati' : 'Spot ottenuti'}`, 'info');
    }

    // ========== MARKET ==========
    function renderMarket() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const category = document.getElementById('filter-category').value;

      let filtered = state.spots.filter(spot => {
        if (spot.status !== 'active') return false;
        if (spot.author === state.user.username) return false;
        if (spot.offeredForTrade) return false; // Non mostrare spot gi√† offerti

        const matchSearch = !search || 
          spot.give.toLowerCase().includes(search) ||
          spot.want.toLowerCase().includes(search) ||
          spot.region.toLowerCase().includes(search) ||
          spot.description.toLowerCase().includes(search);
          
        const matchCategory = category === 'all' || spot.category === category;

        return matchSearch && matchCategory;
      });

      const grid = document.getElementById('market-grid');
      const count = document.getElementById('results-count');
      
      count.textContent = `${filtered.length} risultat${filtered.length === 1 ? 'o' : 'i'}`;

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">üîç</div>
            <div>Nessuno spot trovato</div>
            <p class="text-muted">Prova a modificare i filtri</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(spot => `
        <div class="spot-card" onclick="viewSpotDetail('${spot.id}')">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">üìç ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-success">Disponibile</span>
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offre:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerca:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-primary">${getTimeAgo(spot.createdAt)}</span>
          </div>

          <div class="text-muted" style="margin-top:10px;font-size:12px;font-weight:500">
            di ${escapeHtml(spot.author)}
          </div>
        </div>
      `).join('');
    }

    function resetFilters() {
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-category').value = 'all';
      renderMarket();
      showToast('Filtri resettati');
    }

    // ========== MY SPOTS ==========
    function renderMySpots() {
      renderPublishedSpots();
      renderAcquiredSpots();
      updateProfileStats();
      
      // Aggiorna contatori corretti
      const published = state.spots.filter(s => 
        s.author === state.user.username && 
        !s.acquired && 
        s.status !== 'completed' &&
        !s.offeredForTrade
      );
      
      const acquired = state.spots.filter(s => 
        s.acquired && s.currentOwner === state.user.username
      );
      
      document.getElementById('published-count').textContent = `(${published.length})`;
      document.getElementById('acquired-count').textContent = `(${acquired.length})`;
    }

    function renderPublishedSpots() {
      const mySpots = state.spots.filter(s => 
        s.author === state.user.username && 
        !s.acquired && 
        s.status !== 'completed' &&
        !s.offeredForTrade
      );
      
      const grid = document.getElementById('published-spots-grid');

      if (mySpots.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">üìù</div>
            <div>Nessuno spot pubblicato</div>
            <p class="text-muted">Pubblica il tuo primo spot per iniziare</p>
            <button class="btn btn-primary mt-2" onclick="showView('new')">+ Pubblica spot</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = mySpots.map(spot => `
        <div class="spot-card">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">üìç ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : 'danger'}">
              ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : 'Completato'}
            </span>
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offri:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerchi:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-primary">${getTimeAgo(spot.createdAt)}</span>
          </div>
          
          <div class="spot-actions">
            <button class="btn btn-ghost" onclick="viewSpotDetail('${spot.id}')">Dettagli</button>
            ${spot.coordinates && spot.coordinates.includes(',') ? `
              <button class="btn btn-primary" onclick="openInGoogleMaps('${spot.coordinates}', '${escapeHtml(spot.give)}')">
                <span style="display:flex;align-items:center;gap:4px">üó∫Ô∏è Mappa</span>
              </button>
            ` : ''}
            ${spot.status === 'active' ? `<button class="btn btn-danger" onclick="deleteSpot('${spot.id}')">Elimina</button>` : ''}
          </div>
        </div>
      `).join('');
    }

    function renderAcquiredSpots() {
      // Spot ottenuti da scambi
      const acquiredSpots = state.spots.filter(s => 
        s.acquired === true && s.currentOwner === state.user.username
      );
      
      const grid = document.getElementById('acquired-spots-grid');

      if (acquiredSpots.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">üèÜ</div>
            <div>Nessuno spot ottenuto</div>
            <p class="text-muted">Completa alcuni scambi per ottenere nuovi spot</p>
            <button class="btn btn-primary mt-2" onclick="showView('market')">Vai al mercato</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = acquiredSpots.map(spot => `
        <div class="spot-card">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">üìç ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-success">Ottenuto</span>
            ${spot.offeredForTrade ? '<span class="badge badge-warning" style="margin-left:4px">Offerto</span>' : ''}
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Ex proprietario:</strong> ${escapeHtml(spot.originalAuthor || 'Sconosciuto')}
            </div>
            <div class="spot-exchange-row">
              <strong>Ottenuto il:</strong> ${new Date(spot.acquiredDate || Date.now()).toLocaleDateString('it-IT')}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-warning">Scambio</span>
          </div>
          
          <div class="spot-actions">
            <button class="btn btn-ghost" onclick="viewSpotDetail('${spot.id}')">Dettagli</button>
            ${spot.coordinates ? `
              <button class="btn btn-primary" onclick="openInGoogleMaps('${spot.coordinates}', '${escapeHtml(spot.give)}')">
                <span style="display:flex;align-items:center;gap:4px">üó∫Ô∏è Mappa</span>
              </button>
            ` : ''}
            ${!spot.offeredForTrade ? `
              <button class="btn btn-success" onclick="offerAcquiredSpot('${spot.id}')">Offri in scambio</button>
            ` : `
              <button class="btn btn-ghost" onclick="cancelOffer('${spot.id}')">Annulla offerta</button>
            `}
          </div>
        </div>
      `).join('');
    }

    function loadProfileSettings() {
      document.getElementById('profile-username').value = state.user.username;
      document.getElementById('profile-bio').value = state.user.bio || '';
      document.getElementById('notifications-toggle').checked = state.user.settings.notifications;
      document.getElementById('private-profile-toggle').checked = state.user.settings.privateProfile;
      document.getElementById('precise-coordinates-toggle').checked = state.user.settings.preciseCoordinates;
      document.getElementById('email-confirm-toggle').checked = state.user.settings.emailConfirm;
    }

    function saveProfileSettings() {
      state.user.username = document.getElementById('profile-username').value;
      state.user.bio = document.getElementById('profile-bio').value;
      state.user.settings.notifications = document.getElementById('notifications-toggle').checked;
      state.user.settings.privateProfile = document.getElementById('private-profile-toggle').checked;
      state.user.settings.preciseCoordinates = document.getElementById('precise-coordinates-toggle').checked;
      state.user.settings.emailConfirm = document.getElementById('email-confirm-toggle').checked;
      
      saveState();
      showToast('Impostazioni salvate!', 'success');
    }

    function updateProfileStats() {
      const publishedSpots = state.spots.filter(s => 
        s.author === state.user.username && 
        !s.acquired && 
        s.status !== 'completed' &&
        !s.offeredForTrade
      ).length;
      
      const acquiredSpots = state.spots.filter(s => s.acquired && s.currentOwner === state.user.username).length;
      
      const completedTrades = state.tradeRequests.filter(r => 
        r.status === 'accepted' && 
        (r.fromUser === state.user.username || 
         (state.spots.find(s => s.id === r.spotId)?.author === state.user.username))
      ).length;
      
      const totalTrades = state.tradeRequests.filter(r => 
        r.fromUser === state.user.username || 
        (state.spots.find(s => s.id === r.spotId)?.author === state.user.username)
      ).length;
      
      const successRate = totalTrades > 0 ? Math.round((completedTrades / totalTrades) * 100) : 0;
      
      document.getElementById('total-spots').textContent = publishedSpots + acquiredSpots;
      document.getElementById('acquired-spots').textContent = acquiredSpots;
      document.getElementById('completed-trades').textContent = completedTrades;
      document.getElementById('success-rate').textContent = `${successRate}%`;
    }

    // ========== REQUESTS ==========
    function renderRequests() {
      // Ricevute: solo pending e verifying dove lo spot √® dell'utente
      const received = state.tradeRequests.filter(r => {
        const spot = state.spots.find(s => s.id === r.spotId);
        return spot && spot.author === state.user.username && (r.status === 'pending' || r.status === 'verifying');
      });

      // Inviate: solo pending e verifying dall'utente
      const sent = state.tradeRequests.filter(r => 
        r.fromUser === state.user.username && (r.status === 'pending' || r.status === 'verifying')
      );
      
      // Tutte le richieste (per il tab "Tutte")
      const allRequests = state.tradeRequests.filter(r => 
        r.fromUser === state.user.username || 
        (state.spots.find(s => s.id === r.spotId)?.author === state.user.username)
      );

      document.getElementById('received-count').textContent = `(${received.length})`;
      document.getElementById('sent-count').textContent = `(${sent.length})`;

      // Received requests
      const receivedContainer = document.getElementById('received-requests');
      if (received.length === 0) {
        receivedContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>Nessuna richiesta ricevuta</div>
            <p class="text-muted">Le richieste attive appariranno qui</p>
          </div>
        `;
      } else {
        receivedContainer.innerHTML = received.map(req => renderTradeRequest(req, 'received')).join('');
      }

      // Sent requests
      const sentContainer = document.getElementById('sent-requests');
      if (sent.length === 0) {
        sentContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì§</div>
            <div>Nessuna richiesta inviata</div>
            <p class="text-muted">Le richieste attive appariranno qui</p>
          </div>
        `;
      } else {
        sentContainer.innerHTML = sent.map(req => renderTradeRequest(req, 'sent')).join('');
      }
      
      // All requests
      const allContainer = document.getElementById('all-requests');
      if (allRequests.length === 0) {
        allContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <div>Nessuna richiesta</div>
          </div>
        `;
      } else {
        allContainer.innerHTML = allRequests.map(req => renderTradeRequest(req, 'all')).join('');
      }

      updateRequestsCount();
    }

    function renderTradeRequest(req, type) {
      const spot = state.spots.find(s => s.id === req.spotId);
      if (!spot) return '';

      const offeredSpots = req.offeredSpots.map(id => state.spots.find(s => s.id === id)).filter(Boolean);

      let statusBadge = '';
      let actions = '';

      switch(req.status) {
        case 'pending':
          statusBadge = '<span class="trade-status pending">‚è≥ In attesa</span>';
          if (type === 'received') {
            actions = `<button class="btn btn-success" onclick="chooseSpotFromOffer('${req.id}')">Scegli spot</button>`;
          }
          break;
        case 'verifying':
          const remaining = Math.ceil((req.verificationStartedAt + VERIFICATION_TIME - Date.now()) / 1000);
          statusBadge = `<span class="trade-status verifying">üîç Verifica admin (${remaining}s)</span>`;
          break;
        case 'accepted':
          statusBadge = '<span class="trade-status accepted">‚úÖ Completato</span>';
          break;
        case 'rejected':
          statusBadge = '<span class="trade-status rejected">‚ùå Rifiutato</span>';
          break;
      }

      const isReceived = type === 'received';
      const isSent = type === 'sent';
      
      return `
        <div class="trade-request">
          <div class="flex-between mb-2">
            <div>
              <strong>${isReceived ? 'Da' : isSent ? 'A' : 'Con'}: ${escapeHtml(isReceived ? req.fromUser : isSent ? spot.author : (req.fromUser === state.user.username ? spot.author : req.fromUser))}</strong>
              <div class="text-muted" style="font-size:12px;margin-top:2px">${getTimeAgo(req.createdAt)}</div>
            </div>
            ${statusBadge}
          </div>

          <div class="mb-2">
            <strong>Spot ${isReceived ? 'richiesto' : isSent ? 'offerto' : ''}:</strong> ${escapeHtml(spot.give)}
          </div>

          <div class="mb-2">
            <strong>Spot ${isReceived ? 'offerti' : isSent ? 'richiesti' : 'scambiati'} in cambio:</strong>
            ${offeredSpots.map(s => `
              <div style="padding:8px;background:var(--bg);border-radius:6px;margin-top:6px;border:1px solid var(--border);font-size:12px">
                ${escapeHtml(s.give)} - ${escapeHtml(s.region)}
                ${req.selectedSpotId === s.id ? '<span class="badge badge-success" style="margin-left:6px">‚úì Scelto</span>' : ''}
              </div>
            `).join('')}
          </div>

          ${req.status === 'accepted' && req.selectedSpotId ? renderCoordinates(req) : ''}

          ${actions}
        </div>
      `;
    }

    function renderCoordinates(req) {
      const spot = state.spots.find(s => s.id === req.spotId);
      const selectedSpot = state.spots.find(s => s.id === req.selectedSpotId);
      
      let html = '<div class="coordinates-box">';
      html += '<strong>üéâ Scambio completato! Ecco le coordinate:</strong>';
      
      if (req.fromUser === state.user.username) {
        html += `<div style="margin-top:6px">üìç ${escapeHtml(spot.give)}: ${escapeHtml(spot.coordinates || 'Non disponibili')}</div>`;
        html += `<button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${spot.coordinates}', '${escapeHtml(spot.give)}')">
          Apri in Google Maps
        </button>`;
      } else {
        html += `<div style="margin-top:6px">üìç ${escapeHtml(selectedSpot.give)}: ${escapeHtml(selectedSpot.coordinates || 'Non disponibili')}</div>`;
        html += `<button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${selectedSpot.coordinates}', '${escapeHtml(selectedSpot.give)}')">
          Apri in Google Maps
        </button>`;
      }
      
      html += '</div>';
      return html;
    }

    // ========== TRADE ACTIONS ==========
    function openOfferModal(spotId) {
      const myActiveSpots = state.spots.filter(s => 
        s.author === state.user.username && 
        s.status === 'active' &&
        !s.acquired &&
        !s.offeredForTrade
      );

      if (myActiveSpots.length === 0) {
        showToast('Devi avere almeno uno spot attivo per fare una proposta', 'error');
        showView('new');
        return;
      }

      state.currentOfferId = spotId;
      state.selectedOfferSpots = [];

      const list = document.getElementById('offer-spots-list');
      list.innerHTML = myActiveSpots.map(spot => `
        <label class="spot-selector">
          <input type="checkbox" value="${spot.id}" onchange="toggleOfferSpot('${spot.id}')">
          <div class="spot-selector-content">
            <strong>${escapeHtml(spot.give)}</strong>
            <div class="text-muted" style="font-size:12px;margin-top:2px">üìç ${escapeHtml(spot.region)}</div>
          </div>
        </label>
      `).join('');

      openModal('modal-offer');
    }

    function toggleOfferSpot(spotId) {
      const checkbox = document.querySelector(`input[value="${spotId}"]`);
      const selector = checkbox.closest('.spot-selector');
      
      if (checkbox.checked) {
        if (state.selectedOfferSpots.length >= 3) {
          showToast('Puoi selezionare massimo 3 spot', 'error');
          checkbox.checked = false;
          selector.classList.remove('selected');
          return;
        }
        state.selectedOfferSpots.push(spotId);
        selector.classList.add('selected');
      } else {
        const index = state.selectedOfferSpots.indexOf(spotId);
        if (index > -1) {
          state.selectedOfferSpots.splice(index, 1);
        }
        selector.classList.remove('selected');
      }
    }

    function sendOffer() {
      if (state.selectedOfferSpots.length === 0) {
        showToast('Seleziona almeno uno spot', 'error');
        return;
      }

      const request = {
        id: generateId(),
        spotId: state.currentOfferId,
        fromUser: state.user.username,
        offeredSpots: [...state.selectedOfferSpots],
        status: 'pending',
        createdAt: Date.now()
      };

      state.tradeRequests.push(request);
      
      // Segna gli spot come offerti
      state.selectedOfferSpots.forEach(spotId => {
        const spot = state.spots.find(s => s.id === spotId);
        if (spot) {
          spot.offeredForTrade = true;
        }
      });
      
      saveState();

      closeModal('modal-offer');
      showToast('Proposta inviata con successo!', 'success');
      showView('requests');
      renderMySpots();
    }

    function chooseSpotFromOffer(requestId) {
      state.currentRequestId = requestId;
      const request = state.tradeRequests.find(r => r.id === requestId);
      
      const offeredSpots = request.offeredSpots.map(id => 
        state.spots.find(s => s.id === id)
      ).filter(Boolean);

      const list = document.getElementById('choose-spots-list');
      list.innerHTML = offeredSpots.map(spot => `
        <label class="spot-selector">
          <input type="radio" name="chosen-spot" value="${spot.id}" onchange="selectSpotForTrade('${spot.id}')">
          <div class="spot-selector-content">
            <strong>${escapeHtml(spot.give)}</strong>
            <div class="text-muted" style="font-size:12px;margin-top:2px">üìç ${escapeHtml(spot.region)}</div>
            <div style="margin-top:6px;font-size:12px">${escapeHtml(spot.description.substring(0, 100))}${spot.description.length > 100 ? '...' : ''}</div>
            <div class="tags" style="margin-top:6px">
              <span class="badge badge-info">${spot.category}</span>
            </div>
          </div>
        </label>
      `).join('');

      openModal('modal-choose');
    }

    function selectSpotForTrade(spotId) {
      // Rimuovi la selezione precedente
      document.querySelectorAll('.spot-selector').forEach(el => {
        el.classList.remove('selected');
      });
      
      // Aggiungi la selezione corrente
      const selectedSelector = document.querySelector(`input[value="${spotId}"]`).closest('.spot-selector');
      if (selectedSelector) {
        selectedSelector.classList.add('selected');
      }
    }

    function acceptTrade() {
      const chosen = document.querySelector('input[name="chosen-spot"]:checked');
      if (!chosen) {
        showToast('Seleziona uno spot', 'error');
        return;
      }

      const request = state.tradeRequests.find(r => r.id === state.currentRequestId);
      request.selectedSpotId = chosen.value;
      request.status = 'verifying';
      request.verificationStartedAt = Date.now();

      // Mark spots as in trade
      const mySpot = state.spots.find(s => s.id === request.spotId);
      const theirSpot = state.spots.find(s => s.id === chosen.value);
      if (mySpot) mySpot.status = 'in_trade';
      if (theirSpot) {
        theirSpot.status = 'in_trade';
        theirSpot.offeredForTrade = false; // Rimuovi il flag di offerta
      }

      saveState();
      closeModal('modal-choose');
      showToast('Scambio accettato! In attesa di verifica admin...', 'success');
      renderRequests();
      renderMySpots();
    }

    function offerAcquiredSpot(spotId) {
      const originalSpot = state.spots.find(s => s.id === spotId);
      if (!originalSpot) return;
      
      // Crea una copia dello spot per l'offerta
      const offerSpot = {
        ...originalSpot,
        id: generateId(),
        author: state.user.username,
        status: 'active',
        acquired: false,
        offeredForTrade: false,
        originalSpotId: spotId, // Riferimento allo spot originale
        want: 'Varie opzioni',
        createdAt: Date.now()
      };
      
      // Aggiungi la copia alla lista degli spot
      state.spots.unshift(offerSpot);
      
      // Marca lo spot originale come offerto
      originalSpot.offeredForTrade = true;
      
      saveState();
      showToast('Spot ora disponibile per lo scambio!', 'success');
      renderMySpots();
    }

    function cancelOffer(spotId) {
      const spot = state.spots.find(s => s.id === spotId);
      if (!spot) return;
      
      spot.offeredForTrade = false;
      
      // Rimuovi anche la copia se esiste
      const offerCopy = state.spots.find(s => s.originalSpotId === spotId);
      if (offerCopy) {
        const index = state.spots.indexOf(offerCopy);
        if (index > -1) {
          state.spots.splice(index, 1);
        }
      }
      
      saveState();
      showToast('Offerta annullata', 'success');
      renderMySpots();
    }

    // ========== VERIFICATION CHECKER ==========
    function startVerificationChecker() {
      setInterval(() => {
        let updated = false;

        state.tradeRequests.forEach(req => {
          if (req.status === 'verifying') {
            const elapsed = Date.now() - req.verificationStartedAt;
            if (elapsed >= VERIFICATION_TIME) {
              req.status = 'accepted';
              updated = true;

              // Mark spots as completed
              const spot1 = state.spots.find(s => s.id === req.spotId);
              const spot2 = state.spots.find(s => s.id === req.selectedSpotId);
              
              if (spot1) {
                spot1.status = 'completed';
                spot1.acquired = true;
                spot1.originalAuthor = spot1.author;
                spot1.currentOwner = req.fromUser;
                spot1.acquiredDate = Date.now();
                spot1.author = req.fromUser;
              }
              
              if (spot2) {
                spot2.status = 'completed';
                spot2.acquired = true;
                spot2.originalAuthor = spot2.author;
                spot2.currentOwner = spot1?.originalAuthor || state.user.username;
                spot2.acquiredDate = Date.now();
                spot2.author = spot1?.originalAuthor || state.user.username;
              }

              if (document.getElementById('view-requests').classList.contains('hidden') === false) {
                showToast('Scambio verificato e completato! üéâ', 'success');
              }
            }
          }
        });

        if (updated) {
          saveState();
          if (document.getElementById('view-requests').classList.contains('hidden') === false) {
            renderRequests();
          }
          if (document.getElementById('view-my-spots').classList.contains('hidden') === false) {
            renderMySpots();
          }
        }
      }, 1000);
    }

    // ========== PUBLISH SPOT ==========
    function publishSpot() {
      const give = document.getElementById('input-give').value.trim();
      const want = document.getElementById('input-want').value.trim();
      const region = document.getElementById('input-region').value.trim();
      const coordinates = document.getElementById('input-coordinates').value.trim();
      const category = document.getElementById('input-category').value;
      const description = document.getElementById('input-description').value.trim();
      const legal = document.getElementById('input-legal').checked;

      if (!give || !want || !region) {
        showToast('Compila tutti i campi obbligatori', 'error');
        return;
      }

      if (!coordinates) {
        showToast('Inserisci le coordinate GPS', 'error');
        return;
      }

      if (!legal) {
        showToast('Devi confermare di avere accordi per questo spot', 'error');
        return;
      }

      const spot = {
        id: generateId(),
        give, want, region, coordinates,
        category,
        description: description || 'Nessuna descrizione',
        author: state.user.username,
        status: 'active',
        acquired: false,
        offeredForTrade: false,
        createdAt: Date.now()
      };

      state.spots.unshift(spot);
      saveState();

      // Reset form
      document.getElementById('input-give').value = '';
      document.getElementById('input-want').value = '';
      document.getElementById('input-region').value = '';
      document.getElementById('input-coordinates').value = '';
      document.getElementById('input-description').value = '';
      document.getElementById('input-legal').checked = false;

      showToast('Spot pubblicato con successo!', 'success');
      showView('my-spots');
    }

    function deleteSpot(spotId) {
      if (!confirm('Sei sicuro di voler eliminare questo spot?')) return;
      
      const index = state.spots.findIndex(s => s.id === spotId);
      if (index > -1) {
        state.spots.splice(index, 1);
        saveState();
        showToast('Spot eliminato', 'success');
        renderMySpots();
      }
    }

    // ========== SPOT DETAIL ==========
    function viewSpotDetail(spotId) {
      const spot = state.spots.find(s => s.id === spotId);
      if (!spot) return;

      document.getElementById('detail-title').textContent = spot.give;
      
      const content = document.getElementById('detail-content');
      content.innerHTML = `
        <div class="tags mb-2">
          <span class="badge badge-info">${spot.category}</span>
          <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : 'danger'}">
            ${spot.status === 'active' ? 'Disponibile' : spot.status === 'in_trade' ? 'In scambio' : 'Completato'}
          </span>
          ${spot.acquired ? '<span class="badge badge-warning">Ottenuto</span>' : ''}
          ${spot.offeredForTrade ? '<span class="badge badge-primary">In offerta</span>' : ''}
        </div>

        <div class="mb-2">
          <strong>Autore:</strong> ${escapeHtml(spot.author)}
          ${spot.originalAuthor ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px">Originale: ${escapeHtml(spot.originalAuthor)}</div>` : ''}
        </div>

        <div class="mb-2">
          <strong>Zona:</strong> üìç ${escapeHtml(spot.region)}
        </div>

        <div class="mb-2">
          <strong>Pubblicato:</strong> ${getTimeAgo(spot.createdAt)}
          ${spot.acquiredDate ? `<div style="font-size:12px;color:var(--text-muted);margin-top:2px">Ottenuto: ${new Date(spot.acquiredDate).toLocaleDateString('it-IT')}</div>` : ''}
        </div>

        <div class="spot-exchange mb-2">
          <div class="spot-exchange-row">
            <strong>${spot.acquired ? 'Spot' : 'Offre'}:</strong> ${escapeHtml(spot.give)}
          </div>
          ${!spot.acquired ? `
            <div class="spot-exchange-row">
              <strong>Cerca:</strong> ${escapeHtml(spot.want)}
            </div>
          ` : ''}
        </div>

        <div class="mb-2">
          <strong>Descrizione:</strong>
          <p style="margin-top:6px;font-size:13px">${escapeHtml(spot.description)}</p>
        </div>

        ${spot.coordinates && (spot.status === 'completed' || spot.acquired) ? `
          <div class="coordinates-box">
            <strong>üìç Coordinate GPS</strong>
            <div style="margin-top:6px">${escapeHtml(spot.coordinates)}</div>
            <button class="btn btn-primary" style="margin-top:8px;padding:6px 12px;font-size:12px" onclick="openInGoogleMaps('${spot.coordinates}', '${escapeHtml(spot.give)}')">
              Apri in Google Maps
            </button>
          </div>
        ` : ''}
      `;

      const actions = document.getElementById('detail-actions');
      if (spot.author !== state.user.username && spot.status === 'active') {
        actions.innerHTML = `
          <button class="btn btn-primary btn-lg" onclick="openOfferModal('${spot.id}')">
            Proponi scambio
          </button>
        `;
      } else if (spot.author === state.user.username && spot.status === 'active') {
        actions.innerHTML = `
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="closeModal('modal-detail')">Chiudi</button>
            <button class="btn btn-danger" onclick="deleteSpot('${spot.id}')">Elimina spot</button>
          </div>
        `;
      } else {
        actions.innerHTML = '';
      }

      openModal('modal-detail');
    }

    // ========== GOOGLE MAPS ==========
    function openInGoogleMaps(coordinates, title) {
      if (!coordinates || !coordinates.includes(',')) {
        showToast('Coordinate non valide', 'error');
        return;
      }
      
      const cleanTitle = encodeURIComponent(title);
      const cleanCoords = coordinates.replace(/\s/g, '');
      const url = `https://www.google.com/maps?q=${cleanCoords}&z=15&t=s&hl=it&layer=s`;
      
      window.open(url, '_blank');
    }

    // ========== MODAL ==========
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // ========== UI UPDATES ==========
    function updateUI() {
      updateRequestsCount();
    }

    function updateRequestsCount() {
      const pendingReceived = state.tradeRequests.filter(r => {
        const spot = state.spots.find(s => s.id === r.spotId);
        return spot && spot.author === state.user.username && (r.status === 'pending' || r.status === 'verifying');
      }).length;

      const badge = document.getElementById('requests-count');
      if (pendingReceived > 0) {
        badge.textContent = pendingReceived;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // ========== DEMO DATA ==========
    function addDemoData() {
      if (state.spots.length > 0) return;

      // Spot dell'utente corrente (I miei spot) - SOLO 4
      const mySpots = [
        {
          id: generateId(),
          give: 'Ex fabbrica tessile',
          want: 'Hotel o resort abbandonato',
          region: 'Lombardia - Bergamo',
          coordinates: '45.6983, 9.6773',
          category: 'industriale',
          description: 'Struttura molto fotogenica con macchinari originali.',
          author: state.user.username,
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 86400000
        },
        {
          id: generateId(),
          give: 'Villa liberty con giardino',
          want: 'Struttura militare o bunker',
          region: 'Piemonte - Torino',
          coordinates: '45.0703, 7.6869',
          category: 'villa',
          description: 'Bellissima villa con affreschi. Architettura liberty ben conservata.',
          author: state.user.username,
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 172800000
        },
        {
          id: generateId(),
          give: 'Ex caserma militare',
          want: 'Hotel di montagna abbandonato',
          region: 'Trentino Alto Adige',
          coordinates: '46.4983, 11.3548',
          category: 'militare',
          description: 'Struttura militare degli anni 30 con sotterranei.',
          author: state.user.username,
          status: 'completed',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 345600000
        },
        {
          id: generateId(),
          give: 'Centrale idroelettrica',
          want: 'Hotel termale abbandonato',
          region: 'Valle d\'Aosta',
          coordinates: '45.7376, 7.3207',
          category: 'industriale',
          description: 'Impianto anni 50 con turbine ancora presenti.',
          author: state.user.username,
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 777600000
        }
      ];

      // Altri spot sul mercato
      const marketSpots = [
        {
          id: generateId(),
          give: 'Sanatorio abbandonato',
          want: 'Fabbrica o centrale elettrica',
          region: 'Toscana - Firenze',
          coordinates: '43.7696, 11.2558',
          category: 'sanitario',
          description: 'Architettura razionalista imponente. Ampio parco circostante.',
          author: 'SpotSeeker',
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 259200000
        },
        {
          id: generateId(),
          give: 'Hotel abbandonato anni 70',
          want: 'Villa signorile o castello',
          region: 'Liguria - Genova',
          coordinates: '44.4056, 8.9463',
          category: 'hotel',
          description: 'Hotel con vista mare, strutture ancora intatte.',
          author: 'CoastalHunter',
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 432000000
        },
        {
          id: generateId(),
          give: 'Ex zuccherificio industriale',
          want: 'Ospedale o clinica abbandonata',
          region: 'Emilia Romagna',
          coordinates: '44.4949, 11.3426',
          category: 'industriale',
          description: 'Grande complesso industriale con macchinari originali.',
          author: 'FactoryFinder',
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 518400000
        },
        {
          id: generateId(),
          give: 'Castello medievale',
          want: 'Struttura industriale vintage',
          region: 'Umbria - Perugia',
          coordinates: '43.1107, 12.3908',
          category: 'villa',
          description: 'Castello del 1400 con torri e sotterranei.',
          author: 'HistoryHunter',
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 604800000
        },
        {
          id: generateId(),
          give: 'Ex ospedale psichiatrico',
          want: 'Villa liberty o dec√≤',
          region: 'Veneto - Venezia',
          coordinates: '45.4408, 12.3155',
          category: 'sanitario',
          description: 'Struttura fascista imponente con lunghi corridoi.',
          author: 'ArchitectureFan',
          status: 'active',
          acquired: false,
          offeredForTrade: false,
          createdAt: Date.now() - 691200000
        }
      ];

      // Spot ottenuti dall'utente - SOLO 2
      const acquiredSpots = [
        {
          id: generateId(),
          give: 'Villa sul lago abbandonata',
          want: 'Varie opzioni',
          region: 'Lago di Como',
          coordinates: '45.8170, 9.0856',
          category: 'villa',
          description: 'Villa Liberty direttamente sul lago. Vista mozzafiato.',
          author: state.user.username,
          originalAuthor: 'LakeExplorer',
          status: 'completed',
          acquired: true,
          currentOwner: state.user.username,
          acquiredDate: Date.now() - 864000000,
          createdAt: Date.now() - 950400000,
          offeredForTrade: false
        },
        {
          id: generateId(),
          give: 'Ex miniera di carbone',
          want: 'Varie opzioni',
          region: 'Sardegna - Carbonia',
          coordinates: '39.1642, 8.5219',
          category: 'industriale',
          description: 'Miniera sotterranea con gallerie estese.',
          author: state.user.username,
          originalAuthor: 'UndergroundPro',
          status: 'completed',
          acquired: true,
          currentOwner: state.user.username,
          acquiredDate: Date.now() - 1036800000,
          createdAt: Date.now() - 1123200000,
          offeredForTrade: false
        }
      ];

      state.spots.push(...mySpots, ...marketSpots, ...acquiredSpots);

      // Richieste ricevute (da altri utenti per i nostri spot) - SOLO ACTIVE
      const receivedRequests = [
        {
          id: generateId(),
          spotId: mySpots[0].id,
          fromUser: 'ExplorerIta',
          offeredSpots: [marketSpots[2].id, marketSpots[3].id],
          status: 'pending',
          createdAt: Date.now() - 3600000
        },
        {
          id: generateId(),
          spotId: mySpots[3].id,
          fromUser: 'LakeExplorer',
          offeredSpots: [marketSpots[4].id],
          status: 'verifying',
          selectedSpotId: marketSpots[4].id,
          verificationStartedAt: Date.now() - 5000,
          createdAt: Date.now() - 7200000
        }
      ];

      // Richieste inviate - SOLO 1 ACTIVE
      const sentRequests = [
        {
          id: generateId(),
          spotId: marketSpots[0].id,
          fromUser: state.user.username,
          offeredSpots: [mySpots[0].id, mySpots[3].id],
          status: 'pending',
          createdAt: Date.now() - 5400000
        }
      ];

      // Aggiungi anche alcune richieste completate per la demo
      const completedRequests = [
        {
          id: generateId(),
          spotId: mySpots[2].id,
          fromUser: 'MilitaryFan',
          offeredSpots: [marketSpots[1].id],
          status: 'accepted',
          selectedSpotId: marketSpots[1].id,
          verificationStartedAt: Date.now() - 15000,
          createdAt: Date.now() - 86400000
        },
        {
          id: generateId(),
          spotId: mySpots[0].id,
          fromUser: 'SanatoriumLover',
          offeredSpots: [marketSpots[0].id],
          status: 'rejected',
          createdAt: Date.now() - 172800000
        }
      ];

      state.tradeRequests.push(...receivedRequests, ...sentRequests, ...completedRequests);
      saveState();
    }

    // ========== UTILITIES ==========
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTimeAgo(timestamp) {
      const diff = Date.now() - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}g fa`;
      if (hours > 0) return `${hours}h fa`;
      if (minutes > 0) return `${minutes}m fa`;
      return 'Ora';
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ========== START APP ==========
    init();
  </script>
</body>
</html>
