<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SpotSwap ‚Äî Scambia spot</title>
  <style>
    :root{
      --bg:#0d0d0d;
      --bg-light:#1a1a1a;
      --card:#1f1f1f;
      --card-hover:#252525;
      --border:#2a2a2a;
      --border-light:#333;
      --text:#f5f5f5;
      --text-muted:#999;
      --primary:#dc2626;
      --primary-hover:#b91c1c;
      --primary-light:#ef4444;
      --success:#22c55e;
      --warning:#f59e0b;
      --danger:#dc2626;
      --info:#6366f1;
      --radius:10px;
      --shadow:0 2px 8px rgba(0,0,0,.3);
      --shadow-lg:0 8px 24px rgba(0,0,0,.4);
    }
    
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
    }

    /* LAYOUT */
    header{
      background:linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:100;
      backdrop-filter:blur(10px);
    }
    
    .header-content{
      max-width:1200px;
      margin:0 auto;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
    }
    
    .logo-area{
      display:flex;
      align-items:center;
      gap:10px;
      flex-shrink:0;
    }
    
    .logo{
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-radius:8px;
      display:grid;
      place-items:center;
      font-size:18px;
      font-weight:900;
      color:white;
      box-shadow:0 4px 12px rgba(220,38,38,.3);
    }
    
    .brand h1{
      font-size:18px;
      color:var(--text);
      white-space:nowrap;
      font-weight:700;
      letter-spacing:-0.5px;
    }
    
    .brand p{
      font-size:11px;
      color:var(--text-muted);
      white-space:nowrap;
      font-weight:500;
    }

    nav{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-end;
      flex:1;
      min-width:0;
    }
    
    .nav-btn{
      background:transparent;
      border:1px solid var(--border);
      color:var(--text);
      padding:8px 14px;
      border-radius:7px;
      cursor:pointer;
      font-weight:600;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size:13px;
      position:relative;
      white-space:nowrap;
      flex-shrink:0;
    }
    
    .nav-btn:hover{
      background:var(--card);
      border-color:var(--primary);
      transform:translateY(-1px);
    }
    
    .nav-btn.active{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:white;
      box-shadow:0 4px 12px rgba(220,38,38,.25);
    }

    .nav-btn .badge-count{
      position:absolute;
      top:-6px;
      right:-6px;
      background:var(--primary);
      color:white;
      border-radius:10px;
      padding:2px 6px;
      font-size:10px;
      font-weight:700;
      min-width:16px;
      text-align:center;
      box-shadow:0 2px 6px rgba(220,38,38,.4);
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:20px;
    }

    /* CARDS */
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px;
      margin-bottom:16px;
      transition:all .3s ease;
    }

    .spot-card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      cursor:pointer;
      transition:all .3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      overflow:hidden;
    }
    
    .spot-card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:2px;
      background:linear-gradient(90deg,var(--primary),var(--primary-light));
      opacity:0;
      transition:opacity .3s ease;
    }
    
    .spot-card:hover{
      border-color:var(--primary);
      transform:translateY(-4px);
      box-shadow:var(--shadow-lg);
      background:var(--card-hover);
    }
    
    .spot-card:hover::before{
      opacity:1;
    }

    .spot-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }

    .spot-title{
      font-size:15px;
      font-weight:700;
      margin-bottom:4px;
      color:var(--text);
      letter-spacing:-0.3px;
    }

    .spot-meta{
      font-size:12px;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:4px;
      font-weight:500;
    }

    .spot-exchange{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:10px;
      margin:10px 0;
      font-size:13px;
    }

    .spot-exchange-row{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      margin-bottom:4px;
    }
    
    .spot-exchange-row:last-child{
      margin-bottom:0;
    }

    .spot-exchange strong{
      color:var(--primary);
      font-weight:700;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.5px;
    }

    .tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:10px;
    }

    /* BADGES */
    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:4px 8px;
      border-radius:5px;
      font-size:11px;
      font-weight:700;
      border:1px solid;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .badge-primary{
      background:rgba(220,38,38,.15);
      border-color:var(--primary);
      color:var(--primary-light);
    }

    .badge-success{
      background:rgba(34,197,94,.15);
      border-color:var(--success);
      color:var(--success);
    }

    .badge-warning{
      background:rgba(245,158,11,.15);
      border-color:var(--warning);
      color:var(--warning);
    }

    .badge-danger{
      background:rgba(220,38,38,.15);
      border-color:var(--danger);
      color:var(--danger);
    }

    .badge-info{
      background:rgba(99,102,241,.15);
      border-color:var(--info);
      color:var(--info);
    }

    /* BUTTONS */
    .btn{
      padding:10px 18px;
      border-radius:7px;
      border:1px solid;
      font-weight:600;
      cursor:pointer;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
      font-size:13px;
      text-align:center;
      display:inline-block;
    }

    .btn-primary{
      background:linear-gradient(135deg,var(--primary),var(--primary-light));
      border-color:var(--primary);
      color:white;
      box-shadow:0 4px 12px rgba(220,38,38,.2);
    }

    .btn-primary:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(220,38,38,.3);
    }

    .btn-success{
      background:var(--success);
      border-color:var(--success);
      color:white;
    }
    
    .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(34,197,94,.3);
    }

    .btn-danger{
      background:var(--danger);
      border-color:var(--danger);
      color:white;
    }

    .btn-ghost{
      background:transparent;
      border-color:var(--border);
      color:var(--text);
    }

    .btn-ghost:hover{
      background:var(--card);
      border-color:var(--border-light);
    }

    .btn-lg{
      padding:12px 24px;
      font-size:14px;
      width:100%;
    }

    .btn:disabled{
      opacity:.5;
      cursor:not-allowed;
    }

    /* FORMS */
    .form-group{
      margin-bottom:16px;
    }

    .form-label{
      display:block;
      font-weight:600;
      margin-bottom:6px;
      font-size:13px;
      color:var(--text);
      letter-spacing:0.3px;
    }

    .form-input,
    .form-select,
    .form-textarea{
      width:100%;
      background:var(--bg-light);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:7px;
      font-size:13px;
      transition:all .2s;
      font-family:inherit;
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(220,38,38,.1);
    }

    .form-textarea{
      min-height:100px;
      resize:vertical;
    }

    .form-hint{
      font-size:11px;
      color:var(--text-muted);
      margin-top:4px;
      font-weight:500;
    }

    .form-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
    }

    .checkbox-label{
      display:flex;
      align-items:flex-start;
      gap:10px;
      padding:12px;
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      cursor:pointer;
      transition:all .2s;
    }
    
    .checkbox-label:hover{
      border-color:var(--border-light);
      background:var(--card);
    }

    .checkbox-label input{
      margin-top:2px;
    }

    /* GRID */
    .grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
      gap:14px;
    }

    @media (max-width:768px){
      .grid{
        grid-template-columns:1fr;
        gap:12px;
      }
    }

    /* FILTERS */
    .filters{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:16px;
      margin-bottom:16px;
    }

    /* ALERT */
    .alert{
      padding:12px 16px;
      border-radius:7px;
      margin-bottom:16px;
      border:1px solid;
      font-size:13px;
      font-weight:500;
    }

    .alert-info{
      background:rgba(99,102,241,.1);
      border-color:var(--info);
      color:var(--text);
    }

    .alert-warning{
      background:rgba(245,158,11,.1);
      border-color:var(--warning);
      color:var(--text);
    }

    .alert-success{
      background:rgba(34,197,94,.1);
      border-color:var(--success);
      color:var(--text);
    }

    /* MODAL */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.85);
      backdrop-filter:blur(4px);
      z-index:999;
      display:none;
      align-items:center;
      justify-content:center;
      padding:20px;
      animation:fadeIn .2s ease;
    }

    @keyframes fadeIn{
      from{opacity:0}
      to{opacity:1}
    }

    .modal-overlay.show{
      display:flex;
    }

    .modal{
      background:var(--card);
      border:1px solid var(--border-light);
      border-radius:var(--radius);
      padding:20px;
      max-width:600px;
      width:100%;
      max-height:90vh;
      overflow-y:auto;
      box-shadow:var(--shadow-lg);
      animation:slideUp .3s ease;
    }

    @keyframes slideUp{
      from{
        opacity:0;
        transform:translateY(20px);
      }
      to{
        opacity:1;
        transform:translateY(0);
      }
    }

    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }

    .modal-title{
      font-size:18px;
      font-weight:700;
      letter-spacing:-0.5px;
    }

    .modal-close{
      background:transparent;
      border:none;
      font-size:24px;
      cursor:pointer;
      color:var(--text-muted);
      padding:0;
      width:32px;
      height:32px;
      display:flex;
      align-items:center;
      justify-content:center;
      border-radius:6px;
      transition:all .2s;
    }
    
    .modal-close:hover{
      background:var(--bg-light);
      color:var(--text);
    }

    /* TRADE REQUEST */
    .trade-request{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:8px;
      padding:14px;
      margin-bottom:12px;
      transition:all .2s;
    }
    
    .trade-request:hover{
      border-color:var(--border-light);
    }

    .trade-status{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:5px 10px;
      border-radius:6px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.3px;
    }

    .trade-status.pending{
      background:rgba(245,158,11,.15);
      color:var(--warning);
    }

    .trade-status.verifying{
      background:rgba(99,102,241,.15);
      color:var(--info);
    }

    .trade-status.accepted{
      background:rgba(34,197,94,.15);
      color:var(--success);
    }

    .trade-status.rejected{
      background:rgba(220,38,38,.15);
      color:var(--danger);
    }

    .spot-selector{
      background:var(--bg-light);
      border:1px solid var(--border);
      border-radius:7px;
      padding:12px;
      margin-bottom:10px;
      cursor:pointer;
      transition:all .2s;
    }

    .spot-selector:hover{
      border-color:var(--border-light);
      background:var(--card);
    }

    .spot-selector.selected{
      border-color:var(--primary);
      background:rgba(220,38,38,.05);
    }

    .spot-selector input[type="checkbox"],
    .spot-selector input[type="radio"]{
      margin-right:10px;
    }

    /* COORDINATES REVEAL */
    .coordinates-box{
      background:linear-gradient(135deg,var(--success),#16a34a);
      color:white;
      padding:14px;
      border-radius:8px;
      margin:12px 0;
      font-family:monospace;
      font-size:13px;
      box-shadow:0 4px 12px rgba(34,197,94,.2);
    }

    .coordinates-box strong{
      display:block;
      margin-bottom:6px;
      font-size:14px;
      font-weight:700;
    }

    /* TOAST */
    .toast{
      position:fixed;
      bottom:24px;
      right:24px;
      background:var(--card);
      border:1px solid var(--border-light);
      color:var(--text);
      padding:14px 18px;
      border-radius:8px;
      box-shadow:var(--shadow-lg);
      z-index:1000;
      display:none;
      min-width:250px;
      font-size:13px;
      font-weight:600;
      animation:slideInRight .3s ease;
    }

    @keyframes slideInRight{
      from{
        opacity:0;
        transform:translateX(100px);
      }
      to{
        opacity:1;
        transform:translateX(0);
      }
    }

    .toast.show{display:block}

    .toast.success{
      border-color:var(--success);
      background:rgba(34,197,94,.15);
      color:var(--success);
    }

    .toast.error{
      border-color:var(--danger);
      background:rgba(220,38,38,.15);
      color:var(--danger);
    }

    /* UTILITY */
    .hidden{display:none!important}
    .text-center{text-align:center}
    .text-muted{color:var(--text-muted)}
    .mt-2{margin-top:12px}
    .mb-2{margin-bottom:12px}
    .flex{display:flex}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .gap-2{gap:12px}

    h2{
      font-size:22px;
      margin-bottom:6px;
      font-weight:700;
      letter-spacing:-0.5px;
    }

    h3{
      font-size:16px;
      margin-bottom:10px;
      font-weight:700;
      letter-spacing:-0.3px;
    }

    .section-header{
      margin-bottom:16px;
    }

    .empty-state{
      text-align:center;
      padding:40px 20px;
      color:var(--text-muted);
    }

    .empty-state-icon{
      font-size:40px;
      margin-bottom:12px;
      opacity:.6;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:6px;
      margin-bottom:16px;
      border-bottom:1px solid var(--border);
      overflow-x:auto;
      padding-bottom:2px;
    }

    .tab{
      padding:10px 16px;
      background:transparent;
      border:none;
      color:var(--text-muted);
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all .2s;
      font-weight:600;
      white-space:nowrap;
      flex-shrink:0;
      font-size:13px;
    }

    .tab:hover{
      color:var(--text);
    }

    .tab.active{
      color:var(--primary);
      border-bottom-color:var(--primary);
    }

    /* RESPONSIVE */
    @media (max-width:768px){
      .header-content{
        flex-direction:row;
        flex-wrap:wrap;
        padding:10px 16px;
        gap:10px;
      }
      
      .logo-area{
        flex:1;
        min-width:0;
      }
      
      .logo{
        width:36px;
        height:36px;
        font-size:16px;
      }
      
      .brand h1{
        font-size:16px;
      }
      
      .brand p{
        font-size:10px;
      }
      
      nav{
        order:2;
        flex:1 1 100%;
        overflow-x:auto;
        padding-bottom:6px;
        justify-content:flex-start;
        margin-top:0;
        -webkit-overflow-scrolling:touch;
      }
      
      nav::-webkit-scrollbar{
        height:3px;
      }
      
      nav::-webkit-scrollbar-track{
        background:var(--bg-light);
      }
      
      nav::-webkit-scrollbar-thumb{
        background:var(--border);
        border-radius:2px;
      }
      
      .nav-btn{
        padding:7px 12px;
        font-size:12px;
        flex-shrink:0;
      }
      
      .nav-btn .badge-count{
        position:relative;
        top:0;
        right:0;
        margin-left:4px;
        display:inline-block;
      }

      .container{
        padding:14px;
      }
      
      .form-row{
        grid-template-columns:1fr;
      }

      .toast{
        left:14px;
        right:14px;
        bottom:14px;
        min-width:auto;
      }
      
      .grid{
        grid-template-columns:1fr;
        gap:10px;
      }
      
      .card{
        padding:16px;
      }
      
      .spot-card{
        padding:14px;
      }
      
      .modal{
        padding:18px 14px;
      }
      
      .section-header h2{
        font-size:20px;
      }
      
      .filters{
        padding:14px;
      }
      
      .spot-title{
        font-size:14px;
      }
      
      .spot-meta{
        font-size:11px;
      }
    }
    
    @media (max-width:480px){
      .logo{
        width:32px;
        height:32px;
        font-size:14px;
      }
      
      .brand h1{
        font-size:15px;
      }
      
      .nav-btn{
        padding:6px 10px;
        font-size:11px;
      }
      
      .tabs{
        gap:4px;
      }
      
      .tab{
        padding:8px 12px;
        font-size:12px;
      }
      
      .spot-exchange{
        padding:8px;
        font-size:12px;
      }
    }

    /* CUSTOM SCROLLBAR */
    ::-webkit-scrollbar{
      width:8px;
      height:8px;
    }

    ::-webkit-scrollbar-track{
      background:var(--bg-light);
    }

    ::-webkit-scrollbar-thumb{
      background:var(--border);
      border-radius:4px;
    }

    ::-webkit-scrollbar-thumb:hover{
      background:var(--border-light);
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-content">
      <div class="logo-area">
        <div class="logo">SS</div>
        <div class="brand">
          <h1>SpotSwap</h1>
          <p>Scambia spot</p>
        </div>
      </div>

      <nav>
        <button class="nav-btn active" data-route="market">
          Mercato
        </button>
        <button class="nav-btn" data-route="requests">
          Richieste
          <span class="badge-count" id="requests-count">5</span>
        </button>
        <button class="nav-btn" data-route="my-spots">
          I miei spot
        </button>
        <button class="nav-btn" data-route="new">
          + Nuovo
        </button>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="container">
    <!-- MARKET VIEW -->
    <section id="view-market">
      <div class="alert alert-info">
        <strong>üîí Sistema sicuro</strong> ‚Äî Coordinate visibili solo dopo scambio completato e verifica
      </div>

      <div class="section-header">
        <h2>Mercato degli scambi</h2>
        <p class="text-muted">Trova spot e proponi uno scambio offrendo i tuoi</p>
      </div>

      <div class="filters">
        <div class="form-row">
          <div class="form-group" style="margin:0">
            <label class="form-label">Cerca</label>
            <input type="text" class="form-input" id="filter-search" placeholder="es. hotel, fabbrica...">
          </div>
          
          <div class="form-group" style="margin:0">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="filter-category">
              <option value="all">Tutte</option>
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
        </div>

        <div class="flex gap-2 mt-2" style="align-items:center">
          <button class="btn btn-ghost" id="btn-reset-filters">Reset</button>
          <span class="badge badge-primary" id="results-count">25 risultati</span>
        </div>
      </div>

      <div class="grid" id="market-grid"></div>
    </section>

    <!-- REQUESTS VIEW -->
    <section id="view-requests" class="hidden">
      <div class="section-header">
        <h2>Richieste di scambio</h2>
        <p class="text-muted">Gestisci le richieste ricevute e inviate</p>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="received">Ricevute <span id="received-count">(5)</span></button>
        <button class="tab" data-tab="sent">Inviate <span id="sent-count">(3)</span></button>
      </div>

      <div id="tab-received">
        <div id="received-requests"></div>
      </div>

      <div id="tab-sent" class="hidden">
        <div id="sent-requests"></div>
      </div>
    </section>

    <!-- MY SPOTS VIEW -->
    <section id="view-my-spots" class="hidden">
      <div class="section-header flex-between">
        <div>
          <h2>I miei spot</h2>
          <p class="text-muted">Gestisci i tuoi spot pubblicati</p>
        </div>
        <button class="btn btn-primary" onclick="showView('new')">+ Nuovo spot</button>
      </div>

      <div class="grid" id="my-spots-grid"></div>
    </section>

    <!-- NEW SPOT VIEW -->
    <section id="view-new" class="hidden">
      <div class="section-header">
        <h2>Pubblica nuovo spot</h2>
        <p class="text-muted">Crea un annuncio per scambiare il tuo spot</p>
      </div>

      <div class="card">
        <div class="form-group">
          <label class="form-label">Cosa offri</label>
          <input type="text" class="form-input" id="input-give" maxlength="100" placeholder="es. Ex fabbrica tessile">
          <div class="form-hint">Descrizione breve dello spot che offri in scambio</div>
        </div>

        <div class="form-group">
          <label class="form-label">Cosa cerchi</label>
          <input type="text" class="form-input" id="input-want" maxlength="100" placeholder="es. Hotel o villa abbandonata">
          <div class="form-hint">Cosa vorresti ricevere in cambio</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Zona generica</label>
            <input type="text" class="form-input" id="input-region" placeholder="es. Lombardia nord">
            <div class="form-hint">Solo zona generica, mai l'indirizzo</div>
          </div>

          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select class="form-select" id="input-category">
              <option value="industriale">Industriale</option>
              <option value="hotel">Hotel</option>
              <option value="villa">Villa</option>
              <option value="sanitario">Sanitario</option>
              <option value="militare">Militare</option>
              <option value="altro">Altro</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Coordinate GPS</label>
          <input type="text" class="form-input" id="input-coordinates" placeholder="es. 45.4642, 9.1900">
          <div class="form-hint">‚ö†Ô∏è Saranno visibili SOLO dopo l'accettazione dello scambio e verifica</div>
        </div>

        <div class="form-group">
          <label class="form-label">Descrizione</label>
          <textarea class="form-textarea" id="input-description" maxlength="500" placeholder="Descrivi cosa rende speciale questo spot..."></textarea>
          <div class="form-hint">Info generali sullo spot</div>
        </div>

        <label class="checkbox-label">
          <input type="checkbox" id="input-legal">
          <span>
            <strong>Confermo</strong> di avere accordi personali per questo spot e di poterlo scambiare.
          </span>
        </label>

        <div class="flex gap-2 mt-2">
          <button class="btn btn-ghost" onclick="showView('my-spots')">Annulla</button>
          <button class="btn btn-primary btn-lg" id="btn-publish">Pubblica spot</button>
        </div>
      </div>
    </section>
  </main>

  <!-- MODAL: SELECT SPOTS TO OFFER -->
  <div class="modal-overlay" id="modal-offer">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da offrire (max 3)</h3>
        <button class="modal-close" onclick="closeModal('modal-offer')">&times;</button>
      </div>

      <div class="alert alert-info">
        Seleziona fino a 3 tuoi spot da offrire in cambio. Il proprietario sceglier√† quale accettare.
      </div>

      <div id="offer-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-offer')">Annulla</button>
        <button class="btn btn-primary btn-lg" id="btn-send-offer">Invia proposta</button>
      </div>
    </div>
  </div>

  <!-- MODAL: CHOOSE SPOT FROM OFFER -->
  <div class="modal-overlay" id="modal-choose">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Scegli spot da ricevere</h3>
        <button class="modal-close" onclick="closeModal('modal-choose')">&times;</button>
      </div>

      <div class="alert alert-info">
        Scegli quale spot accettare in cambio del tuo
      </div>

      <div id="choose-spots-list"></div>

      <div class="flex gap-2 mt-2">
        <button class="btn btn-ghost" onclick="closeModal('modal-choose')">Annulla</button>
        <button class="btn btn-success btn-lg" id="btn-accept-trade">Accetta scambio</button>
      </div>
    </div>
  </div>

  <!-- MODAL: SPOT DETAIL -->
  <div class="modal-overlay" id="modal-detail">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="detail-title"></h3>
        <button class="modal-close" onclick="closeModal('modal-detail')">&times;</button>
      </div>

      <div id="detail-content"></div>

      <div id="detail-actions" class="mt-2"></div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <script>
    // ========== CONSTANTS ==========
    const STORAGE_KEY = 'spotswap_v4';
    const VERIFICATION_TIME = 10000; // 10 seconds

    // ========== STATE ==========
    let state = {
      user: {
        username: 'UrbexMaster',
        id: 'user_' + Date.now()
      },
      spots: [],
      tradeRequests: [],
      currentOfferId: null,
      currentRequestId: null,
      selectedOfferSpots: []
    };

    // ========== INIT ==========
    function init() {
      loadState();
      setupEventListeners();
      addDemoData();
      showView('market');
      updateUI();
      startVerificationChecker();
    }

    // ========== STORAGE ==========
    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error('Error loading state:', e);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Error saving state:', e);
      }
    }

    // ========== NAVIGATION ==========
    function showView(view) {
      document.querySelectorAll('section[id^="view-"]').forEach(v => {
        v.classList.add('hidden');
      });
      
      document.getElementById(`view-${view}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.route === view);
      });
      
      if (view === 'market') renderMarket();
      if (view === 'requests') renderRequests();
      if (view === 'my-spots') renderMySpots();
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ========== EVENT LISTENERS ==========
    function setupEventListeners() {
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.addEventListener('click', () => showView(btn.dataset.route));
      });

      ['filter-search', 'filter-category'].forEach(id => {
        document.getElementById(id).addEventListener('input', renderMarket);
      });
      
      document.getElementById('btn-reset-filters').addEventListener('click', resetFilters);
      document.getElementById('btn-publish').addEventListener('click', publishSpot);
      document.getElementById('btn-send-offer').addEventListener('click', sendOffer);
      document.getElementById('btn-accept-trade').addEventListener('click', acceptTrade);

      // Tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabName = tab.dataset.tab;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          document.getElementById('tab-received').classList.toggle('hidden', tabName !== 'received');
          document.getElementById('tab-sent').classList.toggle('hidden', tabName !== 'sent');
        });
      });
    }

    // ========== MARKET ==========
    function renderMarket() {
      const search = document.getElementById('filter-search').value.toLowerCase();
      const category = document.getElementById('filter-category').value;

      let filtered = state.spots.filter(spot => {
        if (spot.status !== 'active') return false;
        if (spot.author === state.user.username) return false;

        const matchSearch = !search || 
          spot.give.toLowerCase().includes(search) ||
          spot.want.toLowerCase().includes(search) ||
          spot.region.toLowerCase().includes(search) ||
          spot.description.toLowerCase().includes(search);
          
        const matchCategory = category === 'all' || spot.category === category;

        return matchSearch && matchCategory;
      });

      const grid = document.getElementById('market-grid');
      const count = document.getElementById('results-count');
      
      count.textContent = `${filtered.length} risultat${filtered.length === 1 ? 'o' : 'i'}`;

      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">üîç</div>
            <div>Nessuno spot trovato</div>
            <p class="text-muted">Prova a modificare i filtri</p>
          </div>
        `;
        return;
      }

      grid.innerHTML = filtered.map(spot => `
        <div class="spot-card" onclick="viewSpotDetail('${spot.id}')">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">üìç ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-success">Disponibile</span>
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offre:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerca:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
            <span class="badge badge-primary">${getTimeAgo(spot.createdAt)}</span>
          </div>

          <div class="text-muted" style="margin-top:10px;font-size:12px;font-weight:500">
            di ${escapeHtml(spot.author)}
          </div>
        </div>
      `).join('');
    }

    function resetFilters() {
      document.getElementById('filter-search').value = '';
      document.getElementById('filter-category').value = 'all';
      renderMarket();
      showToast('Filtri resettati');
    }

    // ========== MY SPOTS ==========
    function renderMySpots() {
      const mySpots = state.spots.filter(s => s.author === state.user.username);
      const grid = document.getElementById('my-spots-grid');

      if (mySpots.length === 0) {
        grid.innerHTML = `
          <div class="card empty-state" style="grid-column:1/-1">
            <div class="empty-state-icon">üìù</div>
            <div>Nessuno spot pubblicato</div>
            <p class="text-muted">Pubblica il tuo primo spot per iniziare</p>
            <button class="btn btn-primary mt-2" onclick="showView('new')">+ Pubblica spot</button>
          </div>
        `;
        return;
      }

      grid.innerHTML = mySpots.map(spot => `
        <div class="spot-card" onclick="viewSpotDetail('${spot.id}')">
          <div class="spot-header">
            <div style="flex:1">
              <div class="spot-title">${escapeHtml(spot.give)}</div>
              <div class="spot-meta">üìç ${escapeHtml(spot.region)}</div>
            </div>
            <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : 'danger'}">
              ${spot.status === 'active' ? 'Attivo' : spot.status === 'in_trade' ? 'In scambio' : 'Completato'}
            </span>
          </div>

          <div class="spot-exchange">
            <div class="spot-exchange-row">
              <strong>Offri:</strong> ${escapeHtml(spot.give)}
            </div>
            <div class="spot-exchange-row">
              <strong>Cerchi:</strong> ${escapeHtml(spot.want)}
            </div>
          </div>

          <div class="tags">
            <span class="badge badge-info">${spot.category}</span>
          </div>
        </div>
      `).join('');
    }

    // ========== REQUESTS ==========
    function renderRequests() {
      const received = state.tradeRequests.filter(r => {
        const spot = state.spots.find(s => s.id === r.spotId);
        return spot && spot.author === state.user.username;
      });

      const sent = state.tradeRequests.filter(r => r.fromUser === state.user.username);

      document.getElementById('received-count').textContent = `(${received.length})`;
      document.getElementById('sent-count').textContent = `(${sent.length})`;

      // Received requests
      const receivedContainer = document.getElementById('received-requests');
      if (received.length === 0) {
        receivedContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <div>Nessuna richiesta ricevuta</div>
          </div>
        `;
      } else {
        receivedContainer.innerHTML = received.map(req => renderTradeRequest(req, 'received')).join('');
      }

      // Sent requests
      const sentContainer = document.getElementById('sent-requests');
      if (sent.length === 0) {
        sentContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì§</div>
            <div>Nessuna richiesta inviata</div>
          </div>
        `;
      } else {
        sentContainer.innerHTML = sent.map(req => renderTradeRequest(req, 'sent')).join('');
      }

      updateRequestsCount();
    }

    function renderTradeRequest(req, type) {
      const spot = state.spots.find(s => s.id === req.spotId);
      if (!spot) return '';

      const offeredSpots = req.offeredSpots.map(id => state.spots.find(s => s.id === id)).filter(Boolean);

      let statusBadge = '';
      let actions = '';

      switch(req.status) {
        case 'pending':
          statusBadge = '<span class="trade-status pending">‚è≥ In attesa</span>';
          if (type === 'received') {
            actions = `<button class="btn btn-success" onclick="chooseSpotFromOffer('${req.id}')">Scegli spot</button>`;
          }
          break;
        case 'verifying':
          const remaining = Math.ceil((req.verificationStartedAt + VERIFICATION_TIME - Date.now()) / 1000);
          statusBadge = `<span class="trade-status verifying">üîç Verifica admin (${remaining}s)</span>`;
          break;
        case 'accepted':
          statusBadge = '<span class="trade-status accepted">‚úÖ Completato</span>';
          break;
        case 'rejected':
          statusBadge = '<span class="trade-status rejected">‚ùå Rifiutato</span>';
          break;
      }

      return `
        <div class="trade-request">
          <div class="flex-between mb-2">
            <div>
              <strong>${type === 'received' ? 'Da' : 'Per'}: ${escapeHtml(type === 'received' ? req.fromUser : spot.author)}</strong>
              <div class="text-muted" style="font-size:12px;margin-top:2px">${getTimeAgo(req.createdAt)}</div>
            </div>
            ${statusBadge}
          </div>

          <div class="mb-2">
            <strong>Spot richiesto:</strong> ${escapeHtml(spot.give)}
          </div>

          <div class="mb-2">
            <strong>Spot offerti in cambio:</strong>
            ${offeredSpots.map(s => `
              <div style="padding:8px;background:var(--bg);border-radius:6px;margin-top:6px;border:1px solid var(--border);font-size:12px">
                ${escapeHtml(s.give)} - ${escapeHtml(s.region)}
                ${req.selectedSpotId === s.id ? '<span class="badge badge-success" style="margin-left:6px">‚úì Scelto</span>' : ''}
              </div>
            `).join('')}
          </div>

          ${req.status === 'accepted' && req.selectedSpotId ? renderCoordinates(req) : ''}

          ${actions}
        </div>
      `;
    }

    function renderCoordinates(req) {
      const spot = state.spots.find(s => s.id === req.spotId);
      const selectedSpot = state.spots.find(s => s.id === req.selectedSpotId);
      
      let html = '<div class="coordinates-box">';
      html += '<strong>üéâ Scambio completato! Ecco le coordinate:</strong>';
      
      if (req.fromUser === state.user.username) {
        html += `<div style="margin-top:6px">üìç ${escapeHtml(spot.give)}: ${escapeHtml(spot.coordinates || 'Non disponibili')}</div>`;
      } else {
        html += `<div style="margin-top:6px">üìç ${escapeHtml(selectedSpot.give)}: ${escapeHtml(selectedSpot.coordinates || 'Non disponibili')}</div>`;
      }
      
      html += '</div>';
      return html;
    }

    // ========== TRADE ACTIONS ==========
    function openOfferModal(spotId) {
      const myActiveSpots = state.spots.filter(s => 
        s.author === state.user.username && 
        s.status === 'active'
      );

      if (myActiveSpots.length === 0) {
        showToast('Devi avere almeno uno spot attivo per fare una proposta', 'error');
        showView('new');
        return;
      }

      state.currentOfferId = spotId;
      state.selectedOfferSpots = [];

      const list = document.getElementById('offer-spots-list');
      list.innerHTML = myActiveSpots.map(spot => `
        <label class="spot-selector">
          <input type="checkbox" value="${spot.id}" onchange="toggleOfferSpot('${spot.id}')">
          <div>
            <strong>${escapeHtml(spot.give)}</strong>
            <div class="text-muted" style="font-size:12px;margin-top:2px">üìç ${escapeHtml(spot.region)}</div>
          </div>
        </label>
      `).join('');

      openModal('modal-offer');
    }

    function toggleOfferSpot(spotId) {
      const index = state.selectedOfferSpots.indexOf(spotId);
      if (index > -1) {
        state.selectedOfferSpots.splice(index, 1);
      } else {
        if (state.selectedOfferSpots.length >= 3) {
          showToast('Puoi selezionare massimo 3 spot', 'error');
          document.querySelector(`input[value="${spotId}"]`).checked = false;
          return;
        }
        state.selectedOfferSpots.push(spotId);
      }
    }

    function sendOffer() {
      if (state.selectedOfferSpots.length === 0) {
        showToast('Seleziona almeno uno spot', 'error');
        return;
      }

      const request = {
        id: generateId(),
        spotId: state.currentOfferId,
        fromUser: state.user.username,
        offeredSpots: [...state.selectedOfferSpots],
        status: 'pending',
        createdAt: Date.now()
      };

      state.tradeRequests.push(request);
      saveState();

      closeModal('modal-offer');
      showToast('Proposta inviata con successo!', 'success');
      showView('requests');
    }

    function chooseSpotFromOffer(requestId) {
      state.currentRequestId = requestId;
      const request = state.tradeRequests.find(r => r.id === requestId);
      
      const offeredSpots = request.offeredSpots.map(id => 
        state.spots.find(s => s.id === id)
      ).filter(Boolean);

      const list = document.getElementById('choose-spots-list');
      list.innerHTML = offeredSpots.map(spot => `
        <label class="spot-selector">
          <input type="radio" name="chosen-spot" value="${spot.id}">
          <div>
            <strong>${escapeHtml(spot.give)}</strong>
            <div class="text-muted" style="font-size:12px;margin-top:2px">üìç ${escapeHtml(spot.region)}</div>
            <div style="margin-top:6px;font-size:12px">${escapeHtml(spot.description)}</div>
            <div class="tags" style="margin-top:6px">
              <span class="badge badge-info">${spot.category}</span>
            </div>
          </div>
        </label>
      `).join('');

      openModal('modal-choose');
    }

    function acceptTrade() {
      const chosen = document.querySelector('input[name="chosen-spot"]:checked');
      if (!chosen) {
        showToast('Seleziona uno spot', 'error');
        return;
      }

      const request = state.tradeRequests.find(r => r.id === state.currentRequestId);
      request.selectedSpotId = chosen.value;
      request.status = 'verifying';
      request.verificationStartedAt = Date.now();

      // Mark spots as in trade
      const mySpot = state.spots.find(s => s.id === request.spotId);
      const theirSpot = state.spots.find(s => s.id === chosen.value);
      if (mySpot) mySpot.status = 'in_trade';
      if (theirSpot) theirSpot.status = 'in_trade';

      saveState();
      closeModal('modal-choose');
      showToast('Scambio accettato! In attesa di verifica admin...', 'success');
      renderRequests();
    }

    // ========== VERIFICATION CHECKER ==========
    function startVerificationChecker() {
      setInterval(() => {
        let updated = false;

        state.tradeRequests.forEach(req => {
          if (req.status === 'verifying') {
            const elapsed = Date.now() - req.verificationStartedAt;
            if (elapsed >= VERIFICATION_TIME) {
              req.status = 'accepted';
              updated = true;

              // Mark spots as completed
              const spot1 = state.spots.find(s => s.id === req.spotId);
              const spot2 = state.spots.find(s => s.id === req.selectedSpotId);
              if (spot1) spot1.status = 'completed';
              if (spot2) spot2.status = 'completed';

              if (document.getElementById('view-requests').classList.contains('hidden') === false) {
                showToast('Scambio verificato e completato! üéâ', 'success');
              }
            }
          }
        });

        if (updated) {
          saveState();
          if (document.getElementById('view-requests').classList.contains('hidden') === false) {
            renderRequests();
          }
        }
      }, 1000);
    }

    // ========== PUBLISH SPOT ==========
    function publishSpot() {
      const give = document.getElementById('input-give').value.trim();
      const want = document.getElementById('input-want').value.trim();
      const region = document.getElementById('input-region').value.trim();
      const coordinates = document.getElementById('input-coordinates').value.trim();
      const category = document.getElementById('input-category').value;
      const description = document.getElementById('input-description').value.trim();
      const legal = document.getElementById('input-legal').checked;

      if (!give || !want || !region) {
        showToast('Compila tutti i campi obbligatori', 'error');
        return;
      }

      if (!coordinates) {
        showToast('Inserisci le coordinate GPS', 'error');
        return;
      }

      if (!legal) {
        showToast('Devi confermare di avere accordi per questo spot', 'error');
        return;
      }

      const spot = {
        id: generateId(),
        give, want, region, coordinates,
        category,
        description: description || 'Nessuna descrizione',
        author: state.user.username,
        status: 'active',
        createdAt: Date.now()
      };

      state.spots.unshift(spot);
      saveState();

      // Reset form
      document.getElementById('input-give').value = '';
      document.getElementById('input-want').value = '';
      document.getElementById('input-region').value = '';
      document.getElementById('input-coordinates').value = '';
      document.getElementById('input-description').value = '';
      document.getElementById('input-legal').checked = false;

      showToast('Spot pubblicato con successo!', 'success');
      showView('my-spots');
    }

    // ========== SPOT DETAIL ==========
    function viewSpotDetail(spotId) {
      const spot = state.spots.find(s => s.id === spotId);
      if (!spot) return;

      document.getElementById('detail-title').textContent = spot.give;
      
      const content = document.getElementById('detail-content');
      content.innerHTML = `
        <div class="tags mb-2">
          <span class="badge badge-info">${spot.category}</span>
          <span class="badge badge-${spot.status === 'active' ? 'success' : spot.status === 'in_trade' ? 'warning' : 'danger'}">
            ${spot.status === 'active' ? 'Disponibile' : spot.status === 'in_trade' ? 'In scambio' : 'Completato'}
          </span>
        </div>

        <div class="mb-2">
          <strong>Autore:</strong> ${escapeHtml(spot.author)}
        </div>

        <div class="mb-2">
          <strong>Zona:</strong> üìç ${escapeHtml(spot.region)}
        </div>

        <div class="mb-2">
          <strong>Pubblicato:</strong> ${getTimeAgo(spot.createdAt)}
        </div>

        <div class="spot-exchange mb-2">
          <div class="spot-exchange-row">
            <strong>Offre:</strong> ${escapeHtml(spot.give)}
          </div>
          <div class="spot-exchange-row">
            <strong>Cerca:</strong> ${escapeHtml(spot.want)}
          </div>
        </div>

        <div class="mb-2">
          <strong>Descrizione:</strong>
          <p style="margin-top:6px;font-size:13px">${escapeHtml(spot.description)}</p>
        </div>

        ${spot.status === 'completed' ? `
          <div class="coordinates-box">
            <strong>üìç Coordinate GPS</strong>
            <div style="margin-top:6px">${escapeHtml(spot.coordinates)}</div>
          </div>
        ` : ''}
      `;

      const actions = document.getElementById('detail-actions');
      if (spot.author !== state.user.username && spot.status === 'active') {
        actions.innerHTML = `
          <button class="btn btn-primary btn-lg" onclick="openOfferModal('${spot.id}')">
            Proponi scambio
          </button>
        `;
      } else {
        actions.innerHTML = '';
      }

      openModal('modal-detail');
    }

    // ========== MODAL ==========
    function openModal(id) {
      document.getElementById(id).classList.add('show');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    // ========== UI UPDATES ==========
    function updateUI() {
      updateRequestsCount();
    }

    function updateRequestsCount() {
      const pendingReceived = state.tradeRequests.filter(r => {
        const spot = state.spots.find(s => s.id === r.spotId);
        return spot && spot.author === state.user.username && r.status === 'pending';
      }).length;

      const badge = document.getElementById('requests-count');
      if (pendingReceived > 0) {
        badge.textContent = pendingReceived;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }

    // ========== DEMO DATA ==========
    function addDemoData() {
      if (state.spots.length > 5) return;

      // Spot dell'utente corrente (I miei spot)
      const mySpots = [
        {
          id: generateId(),
          give: 'Ex fabbrica tessile',
          want: 'Hotel o resort abbandonato',
          region: 'Lombardia - Bergamo',
          coordinates: '45.6983, 9.6773',
          category: 'industriale',
          description: 'Struttura molto fotogenica con macchinari originali.',
          author: state.user.username,
          status: 'active',
          createdAt: Date.now() - 86400000
        },
        {
          id: generateId(),
          give: 'Villa liberty con giardino',
          want: 'Struttura militare o bunker',
          region: 'Piemonte - Torino',
          coordinates: '45.0703, 7.6869',
          category: 'villa',
          description: 'Bellissima villa con affreschi. Architettura liberty ben conservata.',
          author: state.user.username,
          status: 'in_trade',
          createdAt: Date.now() - 172800000
        },
        {
          id: generateId(),
          give: 'Ex caserma militare',
          want: 'Hotel di montagna abbandonato',
          region: 'Trentino Alto Adige',
          coordinates: '46.4983, 11.3548',
          category: 'militare',
          description: 'Struttura militare degli anni 30 con sotterranei.',
          author: state.user.username,
          status: 'completed',
          createdAt: Date.now() - 345600000
        },
        {
          id: generateId(),
          give: 'Centrale idroelettrica',
          want: 'Hotel termale abbandonato',
          region: 'Valle d\'Aosta',
          coordinates: '45.7376, 7.3207',
          category: 'industriale',
          description: 'Impianto anni 50 con turbine ancora presenti.',
          author: state.user.username,
          status: 'active',
          createdAt: Date.now() - 777600000
        }
      ];

      // Altri spot sul mercato
      const marketSpots = [
        {
          id: generateId(),
          give: 'Sanatorio abbandonato',
          want: 'Fabbrica o centrale elettrica',
          region: 'Toscana - Firenze',
          coordinates: '43.7696, 11.2558',
          category: 'sanitario',
          description: 'Architettura razionalista imponente. Ampio parco circostante.',
          author: 'SpotSeeker',
          status: 'active',
          createdAt: Date.now() - 259200000
        },
        {
          id: generateId(),
          give: 'Hotel abbandonato anni 70',
          want: 'Villa signorile o castello',
          region: 'Liguria - Genova',
          coordinates: '44.4056, 8.9463',
          category: 'hotel',
          description: 'Hotel con vista mare, strutture ancora intatte.',
          author: 'CoastalHunter',
          status: 'active',
          createdAt: Date.now() - 432000000
        },
        {
          id: generateId(),
          give: 'Ex zuccherificio industriale',
          want: 'Ospedale o clinica abbandonata',
          region: 'Emilia Romagna',
          coordinates: '44.4949, 11.3426',
          category: 'industriale',
          description: 'Grande complesso industriale con macchinari originali.',
          author: 'FactoryFinder',
          status: 'active',
          createdAt: Date.now() - 518400000
        },
        {
          id: generateId(),
          give: 'Castello medievale',
          want: 'Struttura industriale vintage',
          region: 'Umbria - Perugia',
          coordinates: '43.1107, 12.3908',
          category: 'villa',
          description: 'Castello del 1400 con torri e sotterranei.',
          author: 'HistoryHunter',
          status: 'active',
          createdAt: Date.now() - 604800000
        },
        {
          id: generateId(),
          give: 'Ex ospedale psichiatrico',
          want: 'Villa liberty o dec√≤',
          region: 'Veneto - Venezia',
          coordinates: '45.4408, 12.3155',
          category: 'sanitario',
          description: 'Struttura fascista imponente con lunghi corridoi.',
          author: 'ArchitectureFan',
          status: 'active',
          createdAt: Date.now() - 691200000
        },
        {
          id: generateId(),
          give: 'Villa sul lago abbandonata',
          want: 'Struttura militare costiera',
          region: 'Lago di Como',
          coordinates: '45.8170, 9.0856',
          category: 'villa',
          description: 'Villa Liberty direttamente sul lago. Vista mozzafiato.',
          author: 'LakeExplorer',
          status: 'active',
          createdAt: Date.now() - 864000000
        },
        {
          id: generateId(),
          give: 'Ex miniera di carbone',
          want: 'Sanatorio o ospedale abbandonato',
          region: 'Sardegna - Carbonia',
          coordinates: '39.1642, 8.5219',
          category: 'industriale',
          description: 'Miniera sotterranea con gallerie estese.',
          author: 'UndergroundPro',
          status: 'active',
          createdAt: Date.now() - 950400000
        },
        {
          id: generateId(),
          give: 'Hotel di lusso anni 60 mai aperto',
          want: 'Fabbrica tessile o manifatturiera',
          region: 'Riviera Romagnola',
          coordinates: '44.2244, 12.4443',
          category: 'hotel',
          description: 'Struttura completata ma mai inaugurata. Architettura unica.',
          author: 'UnfinishedBeauty',
          status: 'active',
          createdAt: Date.now() - 1036800000
        },
        {
          id: generateId(),
          give: 'Ex colonia marina',
          want: 'Castello o fortezza',
          region: 'Marche - Ancona',
          coordinates: '43.6158, 13.5189',
          category: 'altro',
          description: 'Architettura razionalista ben conservata. Sul mare.',
          author: 'FascistArchitecture',
          status: 'active',
          createdAt: Date.now() - 1123200000
        },
        {
          id: generateId(),
          give: 'Ex stazione ferroviaria',
          want: 'Villa con cappella privata',
          region: 'Sicilia - Catania',
          coordinates: '37.5079, 15.0830',
          category: 'altro',
          description: 'Stazione in stile liberty con binari ancora presenti.',
          author: 'RailwayHunter',
          status: 'active',
          createdAt: Date.now() - 1209600000
        },
        {
          id: generateId(),
          give: 'Cava di marmo abbandonata',
          want: 'Struttura sanitaria vintage',
          region: 'Toscana - Carrara',
          coordinates: '44.0795, 10.0977',
          category: 'industriale',
          description: 'Cava a cielo aperto con gallerie. Panorama incredibile.',
          author: 'MarbleHunter',
          status: 'active',
          createdAt: Date.now() - 1296000000
        },
        {
          id: generateId(),
          give: 'Ex monastero del 1700',
          want: 'Struttura industriale in mattoni',
          region: 'Abruzzo - L\'Aquila',
          coordinates: '42.3505, 13.3995',
          category: 'altro',
          description: 'Monastero con chiostro intatto e cripta.',
          author: 'MonasteryExplorer',
          status: 'active',
          createdAt: Date.now() - 1382400000
        },
        {
          id: generateId(),
          give: 'Centrale telefonica abbandonata',
          want: 'Villa con piscina abbandonata',
          region: 'Lazio - Roma',
          coordinates: '41.9028, 12.4964',
          category: 'industriale',
          description: 'Struttura anni 70 con apparecchiature vintage.',
          author: 'TelecomExplorer',
          status: 'active',
          createdAt: Date.now() - 1468800000
        }
      ];

      state.spots.push(...mySpots, ...marketSpots);

      // Richieste ricevute (da altri utenti per i nostri spot)
      const receivedRequests = [
        {
          id: generateId(),
          spotId: mySpots[0].id,
          fromUser: 'ExplorerIta',
          offeredSpots: [marketSpots[2].id, marketSpots[3].id],
          status: 'pending',
          createdAt: Date.now() - 3600000
        },
        {
          id: generateId(),
          spotId: mySpots[3].id,
          fromUser: 'LakeExplorer',
          offeredSpots: [marketSpots[5].id],
          status: 'verifying',
          selectedSpotId: marketSpots[5].id,
          verificationStartedAt: Date.now() - 5000,
          createdAt: Date.now() - 7200000
        },
        {
          id: generateId(),
          spotId: mySpots[2].id,
          fromUser: 'MilitaryFan',
          offeredSpots: [marketSpots[1].id],
          status: 'accepted',
          selectedSpotId: marketSpots[1].id,
          verificationStartedAt: Date.now() - 15000,
          createdAt: Date.now() - 86400000
        },
        {
          id: generateId(),
          spotId: mySpots[0].id,
          fromUser: 'SanatoriumLover',
          offeredSpots: [marketSpots[0].id],
          status: 'rejected',
          createdAt: Date.now() - 172800000
        },
        {
          id: generateId(),
          spotId: mySpots[3].id,
          fromUser: 'FactoryFinder',
          offeredSpots: [marketSpots[2].id, marketSpots[6].id],
          status: 'pending',
          createdAt: Date.now() - 1800000
        }
      ];

      // Richieste inviate
      const sentRequests = [
        {
          id: generateId(),
          spotId: marketSpots[0].id,
          fromUser: state.user.username,
          offeredSpots: [mySpots[0].id, mySpots[3].id],
          status: 'pending',
          createdAt: Date.now() - 5400000
        },
        {
          id: generateId(),
          spotId: marketSpots[3].id,
          fromUser: state.user.username,
          offeredSpots: [mySpots[1].id],
          status: 'accepted',
          selectedSpotId: mySpots[1].id,
          verificationStartedAt: Date.now() - 12000,
          createdAt: Date.now() - 43200000
        },
        {
          id: generateId(),
          spotId: marketSpots[5].id,
          fromUser: state.user.username,
          offeredSpots: [mySpots[0].id],
          status: 'verifying',
          selectedSpotId: mySpots[0].id,
          verificationStartedAt: Date.now() - 3000,
          createdAt: Date.now() - 3600000
        }
      ];

      state.tradeRequests.push(...receivedRequests, ...sentRequests);
      saveState();
    }

    // ========== UTILITIES ==========
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getTimeAgo(timestamp) {
      const diff = Date.now() - timestamp;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}g fa`;
      if (hours > 0) return `${hours}h fa`;
      if (minutes > 0) return `${minutes}m fa`;
      return 'Ora';
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast show ' + type;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // ========== START APP ==========
    init();
  </script>
</body>
</html>
